/* ORGanizer for Salesforce - v10000.0.9.53 
 * Author: Enrico Murru (https://organizer.solutions/)
 * Copyright 2016-2024
 */
!function(exports,global){define("change-set",["global","constants","jquery","popup-utils","salesforce-client","change-set-v2","jquery-ui"],function($G,$C,$,PopupUtils,$SalesforceClient,ChangeSetHelperV2){"use sctrict";var $sfclient,window=($G.chrome,$G.window),debug=PopupUtils.newDebugger("ORGanizer: change-set-v2"),_enabled=!1,_componentsHeader=[{name:"labelType",label:"Type"},{name:"apiName",label:"API Name"},{name:"parent",label:"Parent Object"}],handleErrorMessage=function(message){alert(message)},_isOutboundCSPage=!1,_isPackagePage=!1,_isOutboundEditCSPage=!1,_isPackageEditPage=!1,_templateList=[],_isLex=!1,_entityNamesMap={},initPlugin=function(sid,oid,domainAPIUrl,isLex,apiLevel,callback){if(_isLex=isLex,checkBrowserUrl(_isLex)&&!_enabled){_enabled=!0,$sfclient=new $SalesforceClient.Client("https://"+domainAPIUrl,sid,apiLevel||$C.SF_API.LEVEL);var downloadBtn=$("<input/>").attr("type","button").attr("value","Download components").attr("title","ORGanizer - Download current changeset / package").addClass("btn"),templateBtn=$("<input/>").attr("type","button").attr("value","Create Template").attr("title","ORGanizer - Create a template from current changeset/ package").addClass("btn"),addTemplateBtn=$("<input/>").attr("type","button").attr("value","Add Template").attr("title","ORGanizer - Adds all the components of selected template on current changeset / package").addClass("btn"),compareCSBtn=$("<input/>").attr("type","button").attr("value","Compare Template").attr("title","ORGanizer - Compare selected template with current changeset / package").addClass("btn"),deleteBtn=$("<input/>").attr("type","button").attr("value","Remove Template").attr("title","ORGanizer - Remove selected template from list").addClass("btn"),templateCSVBtn=$("<input/>").attr("type","button").attr("value","Extract Template CSV").attr("title","ORGanizer - Extract selected template content in CSV").addClass("btn"),addToChangeSetAndSave=$("<input/>").attr("type","button").attr("name","save-again").addClass("ui-organizer-input").attr("value",_isOutboundEditCSPage?"Add to Change Set and add again":"Add to Package and add again").attr("title","ORGanizer - Add the following components to the CS and open the Add page again").addClass("btn"),downloadWaiting=$('<div style="display:none;"><img src="/img/loading32.gif" width="16"/> Downloading package<br/><small>This may take a while. <strong>Don\'t close this page.</strong></small></div>'),templateWaiting=$('<div style="display:none;"><img src="/img/loading32.gif" width="16"/> Calculating package<br/><small>This may take a while. <strong>Don\'t close this page.</strong></small></div>'),templateCompareWaiting=$('<div style="display:none;"><img src="/img/loading32.gif" width="16"/> Comparing differences<br/><small>This may take a while. <strong>Don\'t close this page.</strong></small></div>'),templateSlct=($('<div style="display:inline;"><img src="/img/loading32.gif" width="16"/> Removing component...</div>'),$("<select />")),pageBlockSection=$('<div class="apexp"><div class="bPageBlock brandSecondaryBrd apexDefaultPageBlock secondaryPalette ui-organizer-pageblock"><div class="pbHeader"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="pbTitle"><h2 class="mainTitle ui-organizer-pageblock-title">ORGanizer Change Set Helper</h2></td><td class="pbButton"><input class="btn ui-show-btn ui-organizer-input" type="button" value="Open Plugin" /></td></tr></tbody></table></div><div class="pbBody"><div class="pbSubsection"><center class="ui-plugin-loader"><img src="/img/loading32.gif" width="16"/>Loading plugin dependences: please wait...</center><div ><a style="display:none;" href="#" id="_templatingToggle" class="ui-organizer-link" >Toggle Templating Mode</a></div><table class="detailList ui-plugin-body" border="0" cellpadding="0" cellspacing="0"><tbody><tr class="ui-download-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><div class="ui-download-td"/></th><td class="dataCol first"><span>Download the content of this package / change set in a zip file.</span></td><th>&nbsp;</th><td>&nbsp;</td></tr><tr class="ui-template-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><div class="ui-template-td"/></th><td class="dataCol first"><span>Create a template from current package / change set to be used to create new changesets.<br/>When the template is ready, you are requested for a viable name and save it.</span></td><th class="labelCol vfLabelColTextWrap first">&nbsp;</th><td class=" dataCol first ui-template-results"/></tr><tr class="ui-template-list-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><label title="Templates for current ORG">Metadata Templates</label></th><td class="dataCol first"><div class="ui-template-list"/></td><th class="labelCol vfLabelColTextWrap first ui-template-list-details-lbl"></th><td class="dataCol first "><div class="ui-template-list-details" /></td></tr><tr class="ui-template-compare-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><div class="ui-template-compare-lbl"/></th><td class="dataCol first"><div class="ui-template-compare"/></td><th class="labelCol vfLabelColTextWrap first "></th><td class="dataCol first "><div class="ui-template-compare-results" /></td></tr><tr class="ui-template-delete-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><div class="ui-template-delete-lbl"/></th><td class="dataCol first"><div class="ui-template-delete"/></td><th class="labelCol vfLabelColTextWrap first "></th><td class="dataCol first "><div class="ui-template-delete-results" /></td></tr></tr><tr class="ui-template-csv-tr"><th class="labelCol vfLabelColTextWrap first" scope="row"><div class="ui-template-csv-lbl"/></th><td class="dataCol first"><div class="ui-template-csv"/></td><th class="labelCol vfLabelColTextWrap first "></th><td class="dataCol first "><div class="ui-template-csv-results" /></td></tr><tr><th class="labelCol vfLabelColTextWrap first"/><td class="dataCol first" colspan="3"><div class="ui-template-comp-list" /></td></tr></tbody></table><div class="ui-component-selection-header-v2"><div class="ui-component-selection-v2"></div></div></div></div><div style="text-align:center"><a style="font-size: 8pt; text-decoration: none; font-family:monospace" title="Help..." href="'+$C.Endpoints.FAQPage+'#changeset" target="_blank">ORGanizer Change Set Helper Plugin</a></div></div></div>');pageBlockSection.find(".ui-template-list").append(templateSlct),pageBlockSection.find(".ui-download-td").append(downloadBtn).append(downloadWaiting),pageBlockSection.find(".ui-template-td").append(templateBtn).append(templateWaiting),pageBlockSection.find(".ui-template-compare-lbl").append(compareCSBtn).append(templateCompareWaiting),pageBlockSection.find(".ui-template-delete-lbl").append(deleteBtn),pageBlockSection.find(".ui-template-csv-lbl").append(templateCSVBtn),pageBlockSection.find(".ui-template-compare").html("Compare the selected template with the current package / changeset to create a template with the components not yet included.<br/><strong>Do this if you are not sure if all the components of the template have already been added.</strong><br/>If differences are found a new template will be automatically created.");var contentSection=pageBlockSection.find(".pbSubsection").hide();pageBlockSection.find("input.ui-show-btn").click(function(){var button=$(this),show=!contentSection.is(":visible");show?(PopupUtils.sendAnalyticsEventToBackground($C.Analytics.EVENTS.CONTENT_ACTION.Actions.OPEN_CHANGESET_HELPER.name,$C.Analytics.EVENTS.CONTENT_ACTION.name),$("#editPage").hide(),contentSection.show("fast"),button.attr("value","Close Plugin")):($("#editPage").show(),contentSection.hide("fast"),button.attr("value","Open Plugin")),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,function(err,params){betaFeatures=(params||{})[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault,_isOutboundEditCSPage||_isPackageEditPage?betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_EDITOR=show:betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_MAINPAGE=show,PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,betaFeatures,function(err,params){})})}),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,function(err,params){betaFeatures=(params||{})[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault,_isOutboundEditCSPage||_isPackageEditPage?(pageBlockSection.find("input.ui-show-btn").attr("value",betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_EDITOR?"Close Plugin":"Open Plugin"),betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_EDITOR?($("#editPage").hide(),contentSection.show()):($("#editPage").show(),contentSection.hide()),betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_MAINPAGE?pageBlockSection.find(".ui-plugin-body").show():pageBlockSection.find(".ui-plugin-body").hide()):(pageBlockSection.find("input.ui-show-btn").attr("value",betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_MAINPAGE?"Close Plugin":"Open Plugin"),betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_MAINPAGE?contentSection.show():contentSection.hide())}),pageBlockSection.find(".ui-template-delete").html("<div>Remove currently selected template from above templates list.</div>"),pageBlockSection.find(".ui-template-csv").html("<div>Download a CSV containing all the components of the currently selected template.</div>");var freezeUI=function(doFreeze){var saveTmpChangesBtn=pageBlockSection.find(".ui-templace-save-changes");doFreeze?(saveTmpChangesBtn.attr("disabled",!0).addClass("btnDisabled").attr("data-old-title",saveTmpChangesBtn.attr("value")).attr("value","Loading..."),templateBtn.attr("disabled",!0).addClass("btnDisabled").attr("data-old-title",templateBtn.attr("value")).attr("value","Loading..."),addTemplateBtn.attr("disabled",!0).addClass("btnDisabled").attr("data-old-title",addTemplateBtn.attr("value")).attr("value","Loading..."),compareCSBtn.attr("disabled",!0).addClass("btnDisabled").attr("data-old-title",compareCSBtn.attr("value")).attr("value","Loading..."),deleteBtn.attr("disabled",!0).addClass("btnDisabled").attr("data-old-title",deleteBtn.attr("value")).attr("value","Loading..."),templateSlct.attr("disabled",!0),pageBlockSection.find(".ui-template-item-action").addClass("linkDisabled")):(saveTmpChangesBtn.removeAttr("disabled").removeClass("btnDisabled").attr("value",saveTmpChangesBtn.attr("data-old-title")),templateBtn.removeAttr("disabled").removeClass("btnDisabled").attr("value",templateBtn.attr("data-old-title")),addTemplateBtn.removeAttr("disabled").removeClass("btnDisabled").attr("value",addTemplateBtn.attr("data-old-title")),compareCSBtn.removeAttr("disabled").removeClass("btnDisabled").attr("value",compareCSBtn.attr("data-old-title")),deleteBtn.removeAttr("disabled").removeClass("btnDisabled").attr("value",deleteBtn.attr("data-old-title")),templateSlct.removeAttr("disabled"),pageBlockSection.find(".ui-template-item-action").removeClass("linkDisabled"))},togglePluginUI=function(enable){enable?pageBlockSection.find(".ui-plugin-loader").hide():pageBlockSection.find(".ui-plugin-loader").show()},sortTemplates=function(tmpList){tmpList.sort(function(a,b){return a.name.toLowerCase().localeCompare(b.name.toLowerCase())})},sortComponents=function(tmpList){tmpList.sort(function(a,b){var r=(a.labelType||"").toLowerCase().localeCompare((b.labelType||"").toLowerCase());return 0==r&&(r=a.name.toLowerCase().localeCompare(b.name.toLowerCase())),r})},refreshORGtemplates=function(){PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,function(err,data){var pluginStorage={templates:[]};data&&data.templates&&data.templates.length&&(pluginStorage=data),_templateList=pluginStorage;pageBlockSection.find(".ui-template-list");if(templateSlct.html(""),pluginStorage.templates.length){var option=$('<option value="">--Select a template --</options>');templateSlct.append(option),sortTemplates(pluginStorage.templates);for(var i=0;i<pluginStorage.templates.length;i++){var t=pluginStorage.templates[i],option=$("<option/>");option.val(i),option.text(t.name+" - "+new Date(t.createdDate).toLocaleDateString()+" "+new Date(t.createdDate).toLocaleTimeString()),templateSlct.append(option)}}else templateSlct.append($('<option value="">-- No template saved --</option>'));templateSlct.unbind("change").on("change",function(){if(templateComponentsDiv.html(""),templateSlct.val()){var compIndex=templateSlct.val();if(compIndex){var template=_templateList.templates[parseInt(compIndex)];if(!template)return handleErrorMessage("Something went wrong: invalid template. Try to reload page.");if(!template.components||!template.components.length)return handleErrorMessage("Something went wrong: no components found on the template");debug.log("template",template),sortComponents(template.components);var table=createComponentsTable(_componentsHeader,template.components);templateComponentsDiv.append("<h3>"+template.name+" <small>components</small></h3>"),templateComponentsDiv.append("<div>Created on "+new Date(template.createdDate).toLocaleDateString()+" "+new Date(template.createdDate).toLocaleTimeString()+"<hr/></div>");var filterInput=$('<input type="text" style="width:250px" placeholder="Filter components..."/>');filterInput.on("keyup",function(){table.find("tbody tr").each(function(){$(this).text().toLowerCase().indexOf(filterInput.val().toLowerCase())>=0?$(this).show():$(this).hide()})}),templateComponentsDiv.append(filterInput);var messagesDiv=$('<div style="display:inline;"/>'),saveTemplateChangesBtn=$("<input/>").attr("type","button").addClass("btn ui-templace-save-changes").attr("value","Save changes");saveTemplateChangesBtn.click(function(){PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,function(err,data){var pluginStorage={templates:[]};data&&data.templates&&data.templates.length&&(pluginStorage=data);for(var i=0;i<pluginStorage.templates.length;i++)if(pluginStorage.templates[i].name===template.name&&pluginStorage.templates[i].createdDate===template.createdDate){pluginStorage.templates[i]=template;break}PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,pluginStorage,function(err,data){if(err)return alert("Something went wrong. ["+err+"]");var msg='Template "'+template.name+'" saved.';messagesDiv.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,msg,"confirm"))})})}),templateComponentsDiv.append(saveTemplateChangesBtn),templateComponentsDiv.append(messagesDiv);var tableDiv=$('<div style="max-height:200px;overflow:auto;"/>').append(table);templateComponentsDiv.append(tableDiv)}}}),templateSlct.trigger("change")})},createComponentsTable=function(headers,components){var table=$('<table class="list" border="0" cellpadding="0" cellspacing="0"><colgroup span="11"></colgroup>'),tbody=$("<tbody></tbody>"),thead=$('<thead class=""><tr class="headerRow"></tr></thead>');table.append(thead).append(tbody);var thead_th='<th class="headerRow" scope="col" colspan="1"></th>',tbody_tr='<tr class="dataRow even  first" onmouseover="if (window.hiOn){hiOn(this);} " onmouseout="if (window.hiOff){hiOff(this);} " onblur="if (window.hiOff){hiOff(this);}" onfocus="if (window.hiOn){hiOn(this);}"></tr>',tbody_td='<td class="dataCell"></td>';thead.find("tr").append('<th class="ui-action"/>');for(var i=0;i<headers.length;i++){var th=$(thead_th).html(headers[i].label).attr("data-field",headers[i].name);thead.find("tr").append(th)}for(var j=0;j<components.length;j++){var tr=$(tbody_tr);tbody.append(tr);var item=components[j];tr.attr("data-component-id",item.id);var tdAction=$('<td class="ui-action"/>');tr.append(tdAction);var removeFromTemplateLnk=$('<a href="#">Remove from Template</a>');if(removeFromTemplateLnk.addClass("ui-template-item-action").attr("data-index",j),removeFromTemplateLnk.click(function(){if(!confirm("Are you sure do you want to remove component from Template? Save template to confirm deletion."))return!1;var index=parseInt($(this).attr("data-index"));return components.splice(index,1),$(this).closest("tr").remove(),!1}),tdAction.append(removeFromTemplateLnk),tdAction.append("<span> | </span>"),!_isLex||!_isOutboundCSPage&&!_isPackagePage){var removeFromCSLnk=$('<a href="#">Remove from Change Set</a>');removeFromCSLnk.addClass("ui-template-item-action").attr("data-index",j),removeFromCSLnk.click(function(){if(!confirm("Are you sure do you want to remove component from current change set / package?"))return!1;var index=parseInt($(this).attr("data-index")),component=components[index];return freezeUI(!0),getPackageId(function(packageId){ChangeSetHelperV2.queryPackage(packageId,function(err,cmpsIds,cmpsList){if(err)return void alert("Something bad happended. Retry.");var components=cmpsList,found=!1;return $.each(cmpsList,function(i){if(components[i].type=_entityNamesMap[components[i].type.label]||components[i].type.label,components[i].id===component.id||components[i].type===component.type&&components[i].parent===component.parent&&(components[i].name===component.name||components[i].apiName===component.apiName)){var ifrm=$("<iframe />").attr("src",components[i].removeLink).hide().on("load",function(){alert("Component removed from Change Set")});return $(document.body).append(ifrm),found=!0,!1}}),freezeUI(!1),found?void 0:alert("Component not found in current Change Set")})}),!1})}tdAction.append(removeFromCSLnk);for(var i=0;i<headers.length;i++){var td=$(tbody_td);tr.append(td),td.html(item[headers[i].name])}}return table},resultTemplatePanel=pageBlockSection.find(".ui-template-results"),resultTemplateComparePanel=pageBlockSection.find(".ui-template-compare-results"),resultTemplateDeletePanel=pageBlockSection.find(".ui-template-delete-results"),resultTemplateCsvPanel=pageBlockSection.find(".ui-template-csv-results"),templateComponentsDiv=pageBlockSection.find(".ui-template-comp-list"),_getEntityApiNamesRetryCount=0,getEntityApiNames=function(callback){var url=PopupUtils.StandardOutboundCSEditPath+"?id="+PopupUtils.getURLParameter("id");if(_isPackageEditPage)url=PopupUtils.StandardPackageEditPath+"?id="+PopupUtils.getURLParameter("id");else if(_isPackagePage){url=window.location.href.split("?")[0];var split=url.split("/"),id=split[split.length-1];url=PopupUtils.StandardPackageEditPath+"?id="+id}url="https://"+window.location.hostname+url,$.ajax({type:"GET",cache:!1,url:url,success:function(data,textStatus,request){var options=$(data).find("#entityType option");if(!options.length)return handleErrorMessage("Something went wrong loading package info: no entity list found. Please reload page to get all working or report a bug. [E01]");var entityMap={};return options.each(function(){entityMap[$(this).text()]=$(this).val()}),callback&&callback(entityMap)},error:function(xhr,status,error){return console.warn("ORGanizer - Something went wrong: cannot get entity api names, will retry in 1 sec...",status,error),_getEntityApiNamesRetryCount++,_getEntityApiNamesRetryCount>3?handleErrorMessage("Something went wrong loading package info. Please reload page to get all working or report a bug. [E02]"):void setTimeout(function(){return getEntityApiNames(callback)},1e3)}})};downloadBtn.click(function(){var packageName=$(".pageDescription").text();if(!packageName)return handleErrorMessage("Impossibile to get the package name.\nTry to refresh the page.");downloadBtn.hide(),downloadWaiting.show();var escapedPackageName=PopupUtils.escapeXML(packageName);$sfclient.retrievePackage(escapedPackageName,function(err,result){if(err)return downloadWaiting.hide(),downloadBtn.show(),handleErrorMessage(err);var retrieveId=result.id,interval=setInterval(function(){$sfclient.checkRetrievePackageStatus(retrieveId,function(err,retResult){return err||retResult.done&&!retResult.success?(clearInterval(interval),downloadWaiting.hide(),downloadBtn.show(),handleErrorMessage(err||retResult.errorMessage)):retResult.done&&retResult.success?(clearInterval(interval),downloadWaiting.hide(),downloadBtn.show(),PopupUtils.triggerDownloadTextFileFromBackground(PopupUtils.skipIllegalFilenameChars(packageName).replace(/\s+/,"_")+".zip","application/zip",retResult.zip,"zip")):void 0})},5e3)})});var getPackageId=function(callback){var addBtn=null;if(_isOutboundCSPage)addBtn=$('input[name$="outboundCs_add"]');else{if(!_isPackagePage){var packageId=PopupUtils.getURLParameter("id");return callback&&callback(packageId)}addBtn=$('input[name$="addComponent"]')}var iframeId=("GET_PCK_ID_"+Math.random()).replace(".",""),ifrm=$("<iframe/>").hide().attr("name",iframeId).attr("id",iframeId);$("body").append(ifrm),addBtn.closest("form").attr("target",iframeId),debug.log("iframeId",iframeId),ifrm.on("load",function(){debug.log("getPackageId",ifrm[0].contentDocument.location.href);var packageURL=ifrm[0].contentDocument.location.href,packageId=PopupUtils.getURLParameter("id",packageURL);return callback&&callback(packageId)}),addBtn.click(),addBtn.closest("form").removeAttr("target")};if(templateBtn.click(function(){freezeUI(!0),templateWaiting.show(),templateBtn.hide(),getPackageId(function(packageId){ChangeSetHelperV2.queryPackage(packageId,function(err,cmpsIds,cmpsList){if(err)return void alert("Something bad happended. Retry.");var components=cmpsList;$.each(components,function(i){components[i].type=_entityNamesMap[components[i].type.label]||components[i].type.label}),resultTemplatePanel.html(""),freezeUI(!1),templateWaiting.hide(),templateBtn.show();var result=$("<div><div><strong>"+components.length+' components retrieved.</strong></div><div><input type="text" style="width:50%" placeholder="Template name"/><button class="btn">Save Template</button></div></div>'),input=result.find("input");input.val($(".pageDescription").text());var saveBtn=result.find("button");saveBtn.click(function(){return input.val()?void PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,function(err,data){var pluginStorage={templates:[]};data&&data.templates&&data.templates.length&&(pluginStorage=data);for(var i=0;i<pluginStorage.templates.length;i++)if(pluginStorage.templates[i].name==input.val()){if(!confirm("Found another template with the same name: do you want to overwrite it?"))return;pluginStorage.templates.splice(i,1);break}pluginStorage.templates.push({name:input.val(),createdDate:(new Date).getTime(),components:components}),PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,pluginStorage,function(err,data){if(err)return alert("Something went wrong. ["+err+"]");var msg='Template "'+input.val()+'" saved.';result.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,msg,"confirm")),refreshORGtemplates()})}):alert("Set a template name.")}),resultTemplatePanel.append(result)})})}),addTemplateBtn.click(function(){if(!templateSlct.val())return handleErrorMessage("Select a template from the template list.");var compIndex=templateSlct.val(),template=_templateList.templates[parseInt(compIndex)];if(!template)return handleErrorMessage("Something went wrong: invalid template. Try to reload page.");if(!template.components||!template.components.length)return handleErrorMessage("Something went wrong: no components found on the template");for(var form=$('form[name="editPage"]'),notImportable=[],i=0;i<template.components.length;i++){var component=template.components[i];if(component.id){var input=$("<input />");input.attr("id","idsORG"+i).attr("name","ids").attr("type","checkbox").attr("value",component.id).prop("checked",!0).hide(),form.append(input)}else notImportable.push(component)}for(var csv='"type","name","parent","apiName","id"',i=0;i<notImportable.length;i++){var c=notImportable[i];csv+='\n"'+(c.type||"").replace('"','""')+'","'+(c.name||"").replace('"','""')+'","'+(c.parent||"").replace('"','""')+'","'+(c.apiName||"").replace('"','""')+'","'+(c.id||"").replace('"','""')+'"'}return notImportable.length==template.components.length?(console.warn("ORGanizer - Cannot import template, no id found on following components: ",notImportable),alert("All the template components are not importable because they miss the ID parameter. Check the FAQ page to read the plugin limitations. \nTemplate has not been imported.\n["+readableComponentsList.join(", ")+"]")):(notImportable.length&&(console.warn("ORGanizer - Canno import all template components, no id found on following components: ",notImportable),alert('Some of the template components are not importable because they miss the ID parameter. Check the FAQ page to read the plugin limitations.\nDownload the CSV containing missing components and then press the "Add" button to continue.'),PopupUtils.triggerDownloadTextFileFromBackground(template.name.replace(/\s+/,"_")+"_not_imported.csv","text/csv",csv)),form.find('input[name="save"]').removeAttr("disabled").removeClass("btnDisabled").attr("type","submit"),void(notImportable.length||form.find('input[name="save"]')[0].click()))}),compareCSBtn.click(function(){if(!templateSlct.val())return handleErrorMessage("Select a template from the template list.");var compIndex=templateSlct.val(),template=_templateList.templates[parseInt(compIndex)];if(!template)return handleErrorMessage("Something went wrong: invalid template. Try to reload page.");if(!template.components||!template.components.length)return handleErrorMessage("Something went wrong: no components found on the template");var packageTable=$('[id$="packageComponentTable"]');_isOutboundCSPage&&(packageTable=$('[id$="OutboundChangeSetComponentList"]'));var components=[];resultTemplateComparePanel.html("");var templateCompleted=function(){for(var subsetComponents=[],i=0;i<template.components.length;i++){for(var tplComponent=template.components[i],found=!1,j=0;j<components.length;j++){var curComponent=components[j];if(curComponent.id&&curComponent.id&&tplComponent.id===curComponent.id||tplComponent.type===curComponent.type&&tplComponent.apiName&&curComponent.apiName&&(curComponent.parent||"")===(tplComponent.parent||"")&&tplComponent.apiName===curComponent.apiName||tplComponent.type===curComponent.type&&tplComponent.name&&curComponent.name&&(curComponent.parent||"")===(tplComponent.parent||"")&&tplComponent.name===curComponent.name){found=!0;break}}found||subsetComponents.push(tplComponent)}var result;if(subsetComponents.length===template.components.length){var msg='Way to go! Template "'+$("<span/>").text(template.name).text()+'" can be imported now!';result=PopupUtils.createStandardVisualforcePageMessage(null,msg,"confirm")}else if(0===subsetComponents.length){var msg='All components of template "'+$("<span/>").text(template.name).text()+'" are already on current package / namespace.<br/>There is no need to import them.';result=PopupUtils.createStandardVisualforcePageMessage(null,msg,"info")}else{result=$('<div><div><div class="ui-tmp-msg"></div><strong>If you want to import it you need to create a new temporary package by selecting a valid name and clicking the "Save Template" button.<br/><small>After adding it to current package / changeset, you can delete it.</small></div><div><input type="text" style="width:50%" placeholder="Template name"/><button class="btn">Save Template</button></div></div>');var msg='Some components of template "'+$("<span/>").text(template.name).text()+'" has already been added to current package / changeset.';result.find(".ui-tmp-msg").append(PopupUtils.createStandardVisualforcePageMessage(null,msg,"warning"));var input=result.find("input");input.val("$TEMP: ["+template.name+"] for ["+$(".pageDescription").text()+"]");var saveBtn=result.find("button");saveBtn.click(function(){return input.val()?void PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,function(err,data){var pluginStorage={templates:[]};data&&data.templates&&data.templates.length&&(pluginStorage=data);for(var i=0;i<pluginStorage.templates.length;i++)if(pluginStorage.templates[i].name==input.val()){if(!confirm("Found another template with the same name: do you want to overwrite it?"))return;pluginStorage.templates.splice(i,1);break}pluginStorage.templates.push({name:input.val(),createdDate:(new Date).getTime(),components:subsetComponents}),PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,pluginStorage,function(err,data){if(err)return alert("Something went wrong. ["+err+"]");var msg='Template "'+input.val()+'"saved.';result.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,msg,"warning")),refreshORGtemplates()})}):alert("Set a template name.")})}resultTemplateComparePanel.append(result)};templateCompareWaiting.show(),compareCSBtn.hide(),freezeUI(!0),getPackageId(function(packageId){ChangeSetHelperV2.queryPackage(packageId,function(err,cmpsIds,cmpsList){return err?void alert("Something bad happended. Retry."):(templateCompareWaiting.hide(),compareCSBtn.show(),freezeUI(!1),components=cmpsList,$.each(components,function(i){components[i].type=_entityNamesMap[components[i].type.label]||components[i].type.label}),void templateCompleted())})})}),deleteBtn.click(function(){if(resultTemplateDeletePanel.html(""),!templateSlct.val())return handleErrorMessage("Select a template from the template list.");var compIndex=templateSlct.val(),template=_templateList.templates[parseInt(compIndex)];return template?void(confirm("Are you sure you want to delete template ["+template.name+"]?")&&PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,function(err,data){var pluginStorage={templates:[]};if(data&&data.templates&&data.templates.length&&(pluginStorage=data),pluginStorage.length<=compIndex)return resultTemplateDeletePanel.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,"Template already deleted","warning"));sortTemplates(pluginStorage.templates);var tmp=pluginStorage.templates[compIndex];return tmp.name!=template.name?resultTemplateDeletePanel.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,"Something went wrong. Please reload page.","error")):(pluginStorage.templates.splice(compIndex,1),void PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_CHANGE_SET,oid,pluginStorage,function(){return refreshORGtemplates(),resultTemplateDeletePanel.html("").append(PopupUtils.createStandardVisualforcePageMessage(null,'Template "'+template.name+'" succesfully deleted.',"confirm"))}))})):handleErrorMessage("Something went wrong: invalid template. Try to reload page.")}),templateCSVBtn.click(function(){if(resultTemplateCsvPanel.html(""),!templateSlct.val())return handleErrorMessage("Select a template from the template list.");var compIndex=templateSlct.val(),template=_templateList.templates[parseInt(compIndex)];if(!template)return handleErrorMessage("Something went wrong: invalid template. Try to reload page.");for(var csv='"type","name","parent","apiName","id"',i=0;i<template.components.length;i++){var c=template.components[i];csv+='\n"'+(c.type||"").replace('"','""')+'","'+(c.name||"").replace('"','""')+'","'+(c.parent||"").replace('"','""')+'","'+(c.apiName||"").replace('"','""')+'","'+(c.id||"").replace('"','""')+'"'}var fileName=template.name.replace(/\s+/gi,"_").trim();fileName=fileName.replace(/[/\\?%*:|"<>\.]/gi,"_"),fileName+=".csv",debug.log("Download CSV: "+fileName),PopupUtils.triggerDownloadTextFileFromBackground(fileName,"text/csv",csv)}),addToChangeSetAndSave.click(function(){var retURL=PopupUtils.StandardOutboundCSEditPath+"?id="+PopupUtils.getURLParameter("id"),form=$('form[name="editPage"]#editPage'),prevRetURL=editCSForm.find('input[type="hidden"][name="retURL"]').val(),selectedEntity=editCSForm.find("#entityType").val();retURL+="&retURL="+encodeURIComponent(prevRetURL),retURL+="&entityType="+selectedEntity,form.find('input[type="hidden"][name="retURL"]').val(retURL);var saveBtn=editCSForm.find('input[name="save"]');saveBtn.removeAttr("disabled").removeClass("btnDisabled").attr("type","submit")[0].click()}),_isLex&&(_isOutboundCSPage||_isPackagePage)){var warning='(Template manipulation is no more reachable from this LEX page. You must click on the "Add/Remove/Templates" button.)',warningLbl=$("<div/>").addClass("ui-organizer-link").text(warning);
pageBlockSection.find(".ui-template-td > input").addClass("btnDisabled").unbind("click").attr("disabled","disabled").attr("title",warning),pageBlockSection.find(".ui-template-tr > td > span").addClass("ui-text-disabled").after(warningLbl.clone()),pageBlockSection.find(".ui-template-compare-lbl > input").addClass("btnDisabled").unbind("click").attr("disabled","disabled").attr("title",warning),pageBlockSection.find(".ui-template-compare").addClass("ui-text-disabled").append(warningLbl.clone())}if(_isOutboundCSPage){$('form[id$=":detail_form"]').before(pageBlockSection);var form=$('form[id$="outboundChangeSetDetailPageBody:outboundChangeSetDetailPageBody:detail_form"]'),uniqueId=(Math.random()*Math.random()+"").replace(".","_");form.append($('<span id="'+uniqueId+'"/>'));var _mutationObserver=PopupUtils.observeDOM(form[0],function(){if(!$("span#"+uniqueId).length)return debug.log("Form refreshed by SF."),renameAddButton(),void PopupUtils.unobserveDOM(_mutationObserver)})}else _isPackagePage?$('form[id$="ViewAllPackage:theForm"]').before(pageBlockSection):(_isOutboundEditCSPage||_isPackageEditPage)&&($('form[name="editPage"]').before(pageBlockSection),pageBlockSection.find(".ui-template-list-details-lbl").append(addTemplateBtn),pageBlockSection.find(".ui-template-list-details").html('Add the selected template to the current package / change set.<br/>Be sure the metadata components included are not included in the current package / change set (use the "Compare" button).<br/><strong>Elaboration can take a while if template has a lot of components.</strong>'));refreshORGtemplates();var editCSForm=$('form[name="editPage"]#editPage');if(editCSForm.length){$('input[name="cancel"].btn').before(addToChangeSetAndSave);var td=editCSForm.find("#entityType").parent(),inputSearch=$("<input />").attr("type","test").addClass("ui-organizer-input").css("width","200px").css("margin-left","30px").attr("title","Quick filter components list (current page)  - ORGanizer Changeset Helper").attr("placeholder","Quick search components...");td.append(inputSearch),inputSearch.on("keyup",function(){$(this).val()?editCSForm.find("#allBox").attr("disabled",!0):editCSForm.find("#allBox").attr("disabled",!1),$("div.listRelatedObject").find("table.list").find("tr.dataRow").each(function(){$(this).text().toLowerCase().indexOf(inputSearch.val().toLowerCase())>=0?$(this).show():$(this).hide()})});var csId=PopupUtils.getURLParameter("id"),lsc=PopupUtils.getURLParameter("lsc")||"",et=$("#entityType").val(),retURL=editCSForm.find('input[type="hidden"][name="retURL"]').val(),cancelURL=editCSForm.find('input[type="hidden"][name="cancelURL"]').val(),url=window.location.href.split("?")[0]+"?rowsperpage=20000&entityType="+et+"&id="+csId;lsc&&(url+="&lsc="+lsc),retURL&&(url+="&retURL="+encodeURIComponent(retURL)),cancelURL&&(url+="&cancelURL="+encodeURIComponent(cancelURL));var expandeComponentsListLnk=$("<a/>").attr("href",url).addClass("ui-organizer-link").html("Expand component list. . .").css("margin-left","20px").attr("title","Refresh current page showing the maximum number of components - ORGanizer Changeset Helper");td.append(expandeComponentsListLnk)}var renameAddButton=function(){_isOutboundCSPage?$('input[name$="outboundCs_add"]').addClass("ui-organizer-input").attr("value","Add / Remove / Templates"):_isPackagePage&&$('input[name$="addComponent"]').addClass("ui-organizer-input").attr("value","Add / Remove / Templates")};if(togglePluginUI(!1,!1),getEntityApiNames(function(entityMap){return _entityNamesMap=entityMap,togglePluginUI(!0),callback&&callback()}),_isOutboundEditCSPage||_isPackageEditPage){var csV2Body=ChangeSetHelperV2.render(sid,oid,domainAPIUrl,isLex,apiLevel,function(){});pageBlockSection.find(".ui-component-selection-v2").append(csV2Body),pageBlockSection.find("#_templatingToggle").show().click(function(){pageBlockSection.find(".ui-plugin-body").toggle(),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,function(err,params){betaFeatures=(params||{})[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault,betaFeatures.CHANGESET_HELPER_OPTIONS.SHOW_ON_MAINPAGE=pageBlockSection.find(".ui-plugin-body").is(":visible"),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,betaFeatures,function(err,params){})})})}else renameAddButton()}},checkBrowserUrl=function(isLex){return _isOutboundCSPage=window.location.href.indexOf(PopupUtils.StandardOutboundCSPath)>0,_isPackagePage=window.location.href.indexOf("/033")>0,_isOutboundEditCSPage=window.location.href.indexOf(PopupUtils.StandardOutboundCSEditPath)>0,_isPackageEditPage=window.location.href.indexOf(PopupUtils.StandardPackageEditPath)>0,_isOutboundCSPage||_isPackagePage||_isOutboundEditCSPage||_isPackageEditPage};return{render:initPlugin,isAllowed:checkBrowserUrl}}),global.true=exports}({},function(){return this}());