/* ORGanizer for Salesforce - v10000.0.9.53 
 * Author: Enrico Murru (https://organizer.solutions/)
 * Copyright 2016-2024
 */
!function(exports,global){require(["jquery","global","constants","crypto","lz-string","popup-utils","salesforce-client","zip","jquery-ui","bootstrap-colorpicker","bootstrap-modal","bootstrap-tab","bootstrap-collapse","bootstrap-dropdown"],function($,$G,$C,CryptoJS,LZString,PopupUtils,$SalesforceClient,zip){"use sctrict";var debug=PopupUtils.newDebugger("Profile Manager");zip.workerScriptsPath=chrome.runtime.getURL("/libs/zip/");var $client,server,pluginStorage,API_LEVEL="43.0",CHECK_STATUS_TIMEOUT=2e3,CHECK_DEPLOY_LINK="/changemgmt/monitorDeployment.apexp",orgId=PopupUtils.getURLParameter("oid"),DAYS_LIST=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],profiles=[],selectedProfiles=[],selectedDays=[];PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBetaFeatures],function(err,params){params&&params[PopupUtils.StorageParamNameBetaFeatures]&&params[PopupUtils.StorageParamNameBetaFeatures].DARK_MODE||$("body").removeClass("bnsn-dark")}),$("#profilesHelp").attr("href",$C.Endpoints.FAQPage+"#profiles"),$("#checkDeployLnk").click(function(){window.open("https://"+server+CHECK_DEPLOY_LINK)});var loadingMessage=function(msg){var modalEl=$("#loadingModal");modalEl.find("#loadingMessage").text(msg),modalEl.modal({keyboard:!1,backdrop:"static"}).modal(msg?"show":"hide")},handleError=function(msg,callback){$("#alertBox").find(".modal-body p").html(msg),$("#alertBox").modal("show").on("hidden.bs.modal",function(){return callback&&callback()})},handleMessageDialog=function(msg,callback){$("#messageBox").find(".modal-body p").html(msg),$("#messageBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("hidden.bs.modal",function(){return callback&&callback()})},handleConfirmDialog=function(msg,callback){$("#confirmBox").find(".modal-body p").html(msg),$("#confirmBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#confirmBox").find(".ui-no").focus()}),$("#confirmBox").find(".ui-yes").unbind("click").click(function(){return callback&&callback(!0)}),$("#confirmBox").find(".ui-no").unbind("click").click(function(){return callback&&callback(!1)})},showLoginhoursModal=function(slctPrfls,days,callback){debug.log("showLoginhoursModal",slctPrfls,days);for(var profilesNamesList=[],i=0;i<slctPrfls.length;i++)profilesNamesList.push(profiles[parseInt(slctPrfls[i])].name);var startPreset=((profiles[parseInt(slctPrfls[0])].loginHours||{})[days[0]]||{}).start,endPreset=((profiles[parseInt(slctPrfls[0])].loginHours||{})[days[0]]||{}).end;startPreset=startPreset||0===startPreset?startPreset:"",endPreset=endPreset||0===endPreset?endPreset:"",$("#loginHoursBox").find("#startSlct").val(startPreset),$("#loginHoursBox").find("#endSlct").val(endPreset),$("#loginHoursBox").find(".modal-body #loginHoursDetails").text(JSON.stringify(profilesNamesList.join(", "))),$("#loginHoursBox").find(".modal-body #modalDaySpan").text(days.join(", ")),$("#loginHoursBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#loginHoursBox").find(".ui-cancel").focus()}),callback&&($("#loginHoursBox").find(".ui-save").unbind("click").click(function(){var start=$("#loginHoursBox").find("#startSlct").val(),end=$("#loginHoursBox").find("#endSlct").val();return""!==start&&""===end||""===start&&""!==end?handleError("Start and End time should be selected or both empty."):""!==start&&""!==end&&(start=parseInt(start),end=parseInt(end),end<start)?handleError("End time must be greater than Start time."):($("#loginHoursBox").modal("hide"),callback(!0,{start:start,end:end}))}),$("#loginHoursBox").find(".ui-cancel").unbind("click").click(function(){return $("#loginHoursBox").modal("hide"),callback(!1)}))},checkStatus=function checkStatus(retrieveId){setTimeout(function(){$client.checkRetrievePackageStatus(retrieveId,function(err,results){return debug.log(new Date,retrieveId,err,results),err?(handleError("Unexpected error [1]: "+err),debug.log("ERROR: ",err)):results.done?readZIP(results.zip,function(err,results){return debug.log(err,results),err?handleError("Unexpected error [2]: "+err):(drawProfiles(),void loadingMessage(""))}):checkStatus(retrieveId)})},CHECK_STATUS_TIMEOUT)},checkDeployStatus=function(retrieveId,callback){setTimeout(function(){$client.checkDeployPackageStatus(retrieveId,function(err,results){return debug.log(new Date,retrieveId,"results:",results,err),err?callback&&callback(err,results):results.done?(debug.log("checkDeployStatus done"),callback&&callback(err,results)):(debug.log("checkDeployStatus waiting..."),checkDeployStatus(retrieveId,callback))})},CHECK_STATUS_TIMEOUT)},readFile=function(entry,next){return function(){entry.getData(new zip.TextWriter,function(text){var profileSettings={loginHours:{},custom:!1,name:decodeURIComponent(entry.filename.replace("profiles/","").replace(".profile","")),xml:text};profiles.push(profileSettings);var xml=$(text),loginHours=xml.find("loginHours");return profileSettings.custom="true"===xml.find("custom").text(),loginHours.length?(loginHours.children().each(function(){var tagName=$(this).prop("tagName").toLowerCase(),dayName=tagName.replace(/end$/,"").replace(/start$/,""),lh=profileSettings.loginHours[dayName];lh||(lh={},profileSettings.loginHours[dayName]=lh),tagName.endsWith("end")?lh.end=parseInt($(this).text()):tagName.endsWith("start")&&(lh.start=parseInt($(this).text()))}),next()):next()})}},readZIP=function(data,callback){zip.createReader(new zip.Data64URIReader(data),function(reader){reader.getEntries(function(entries){if(entries.length){for(var prevFn=null,finalCallback=function(){return reader.close(function(){}),callback&&callback(null,profiles)},i=0;i<entries.length;i++)0!==entries[i].filename.indexOf("profiles/")||entries[i].filename.indexOf(".profile")<0||(prevFn=readFile(entries[i],null==prevFn?finalCallback:prevFn));return prevFn()}},function(error){return callback&&callback(error)})})},loginHourToString=function(time){try{time=parseInt(time)}catch(ex){}return Number.isInteger(time)?(time=parseInt(time),time/=60,0==time?time="12 AM":12==time?time+=" PM":24==time?time="End of day":time<12?time+=" AM":time=time-12+" PM"):time="--",time},drawProfiles=function(){var table=$("table.ui-profiles-content-table"),tbody=(table.find("thead"),table.find("tbody"));profiles.sort(function(x,y){return x.name.toLowerCase()<y.name.toLowerCase()?-1:x.name.toLowerCase()>y.name.toLowerCase()?1:0}),debug.log("profiles",profiles);for(var i=0;i<profiles.length;i++){var tr=$("<tr/>").attr("data-profile-id",i),tdAction=$("<td/>"),undoBtn=$('<button class="btn btn-default ui-undo-profile-btn" title="Undo changes"><span class="fa fa-undo"></span></button>');tdAction.append(undoBtn),tr.append(tdAction);var td=$("<td/>").addClass("ui-profile"),text=$("<span/>").text(profiles[i].name);td.append(text),tr.append(td);for(var d=0;d<DAYS_LIST.length;d++){var start=loginHourToString((profiles[i].loginHours[DAYS_LIST[d]]||{}).start),end=loginHourToString((profiles[i].loginHours[DAYS_LIST[d]]||{}).end),tdStart=$("<td/>").text(start).addClass("ui-profile-start").attr("data-profile-day",DAYS_LIST[d]).attr("title",profiles[i].name+": "+DAYS_LIST[d]+" start"),tdEnd=$("<td/>").text(end).attr("data-profile-day",DAYS_LIST[d]).addClass("ui-profile-end").attr("title",profiles[i].name+": "+DAYS_LIST[d]+" end");tr.append(tdStart),tr.append(tdEnd)}tbody.append(tr)}$(".ui-profile-start, .ui-profile-end").dblclick(function(){var days=selectedDays.length?selectedDays:[$(this).attr("data-profile-day")],rowProfileId=$(this).closest("tr").attr("data-profile-id"),selProf=selectedProfiles.length?selectedProfiles:[rowProfileId];return showLoginhoursModal(selProf,days,function(result,params){if(debug.log("showLoginhoursModal callback: ",result,params),result)for(var i=0;i<selProf.length;i++){var profileIndex=parseInt(selProf[i]),profile=profiles[profileIndex];profile.loginHours||(profile.loginHours={});for(var d=0;d<days.length;d++){profile.loginHours[days[d]]||(profile.loginHours[days[d]]={}),profile.loginHours[days[d]].updated=!0,profile.loginHours[days[d]].oldStart=profile.loginHours[days[d]].start,profile.loginHours[days[d]].oldEnd=profile.loginHours[days[d]].end,profile.loginHours[days[d]].oldStart||0===profile.loginHours[days[d]].oldStart||(profile.loginHours[days[d]].oldStart=""),profile.loginHours[days[d]].oldEnd||0===profile.loginHours[days[d]].oldEnd||(profile.loginHours[days[d]].oldEnd=""),profile.loginHours[days[d]].start=params.start,profile.loginHours[days[d]].end=params.end;var profileRow=$('tr[data-profile-id="'+profileIndex+'"]');profileRow.find('td.ui-profile-start[data-profile-day="'+days[d]+'"]').addClass("changed").text(loginHourToString(params.start)),profileRow.find('td.ui-profile-end[data-profile-day="'+days[d]+'"]').addClass("changed").text(loginHourToString(params.end)),profileRow.find("td.ui-profile span").text(profile.name+" *").addClass("changed")}}})}),$(".ui-profile").click(function(){var container=$(this).closest("td"),profileId=$(this).closest("tr").attr("data-profile-id");debug.log("selected profile",profileId);var selectedIndex=selectedProfiles.indexOf(profileId);selectedIndex>=0?(container.removeClass("selected"),selectedProfiles.splice(selectedIndex,1),$("#profileTH").removeClass("selected")):(container.addClass("selected"),selectedProfiles.push(profileId)),debug.log("selectedProfiles",selectedProfiles),displaySelectedProfilesOnFooter()}),$("#profileTH").click(function(){if(selectedProfiles=[],$(this).hasClass("selected"))$(".ui-profile").removeClass("selected"),$("#profileTH").removeClass("selected");else{$("#profileTH").addClass("selected"),$(".ui-profile").addClass("selected");for(var p=0;p<profiles.length;p++)selectedProfiles.push(""+p)}displaySelectedProfilesOnFooter()}),$(".ui-day-th").click(function(){var day=$(this).attr("data-day"),dayIndex=selectedDays.indexOf(day);dayIndex<0?($(this).addClass("selected"),selectedDays.push(day)):($(this).removeClass("selected"),selectedDays.splice(dayIndex,1)),debug.log("selectedDays",selectedDays)}),$("button.ui-undo-profile-btn").click(function(){var profileRow=$(this).closest("tr"),profileIndex=parseInt(profileRow.attr("data-profile-id")),profile=profiles[profileIndex];profile.loginHours||(profile.loginHours={});for(var d=0;d<DAYS_LIST.length;d++){var day=DAYS_LIST[d];profile.loginHours[day]||(profile.loginHours[day]={}),profile.loginHours[day].updated=!1,"undefined"!=typeof profile.loginHours[day].oldStart&&(profile.loginHours[day].start=profile.loginHours[day].oldStart,delete profile.loginHours[day].oldStart),"undefined"!=typeof profile.loginHours[day].oldEnd&&(profile.loginHours[day].end=profile.loginHours[day].oldEnd,delete profile.loginHours[day].oldEnd);var profileRow=$('tr[data-profile-id="'+profileIndex+'"]');profileRow.find('td.ui-profile-start[data-profile-day="'+day+'"]').removeClass("changed").text(loginHourToString(profile.loginHours[day].start)),profileRow.find('td.ui-profile-end[data-profile-day="'+day+'"]').removeClass("changed").text(loginHourToString(profile.loginHours[day].end)),profileRow.find("td.ui-profile span").text(profile.name).removeClass("changed")}})},displaySelectedProfilesOnFooter=function(){for(var profilesNamesList=[],i=0;i<selectedProfiles.length;i++)profilesNamesList.push(profiles[parseInt(selectedProfiles[i])].name);$("#slctProfilesFooter").text(profilesNamesList.length?profilesNamesList.join(", "):"none")},writeFiles=function(files,callback){zip.createWriter(new zip.BlobWriter,function(writer){for(var finalCallback=function(){writer.close(function(blob){return callback&&callback(null,blob)})},writeSingleFile=function(file,next){return function(){writer.add(file.name,new zip.TextReader(file.content),function(){return next&&next()},function(currentIndex,totalIndex){})}},tmpFn=null,i=0;i<files.length;i++)tmpFn=writeSingleFile(files[i],tmpFn?tmpFn:finalCallback);return tmpFn()},function(error){return callback&&callback(error)})},deployBtnClick=function(){return handleConfirmDialog("Are you sure do you want to deploy this configuration?",function(result){function getTimeFromDay(profile,day,type){var trailing="start"===type?"Start":"End";return profile&&profile.loginHours?"undefined"==typeof profile.loginHours[day]||null===profile.loginHours[day]?"":""===profile.loginHours[day][type]?"":"<"+day+trailing+">"+profile.loginHours[day][type]+"</"+day+trailing+">":""}if(result){for(var files=[],packageXML='<?xml version="1.0" encoding="UTF-8"?><Package xmlns="http://soap.sforce.com/2006/04/metadata">',p=0;p<profiles.length;p++){var profile=profiles[p];if(profile.loginHours){for(var changed=!1,d=0;d<DAYS_LIST.length;d++){var day=DAYS_LIST[d];if(profile.loginHours[day]&&profile.loginHours[day].updated){changed=!0;break}}if(changed){for(var profileName=encodeURIComponent(profile.name),profileBody='<?xml version="1.0" encoding="UTF-8"?><Profile xmlns="http://soap.sforce.com/2006/04/metadata"><loginHours>',d=0;d<DAYS_LIST.length;d++){var day=DAYS_LIST[d];profileBody+=getTimeFromDay(profile,day,"start")+getTimeFromDay(profile,day,"end")}profileBody+="</loginHours></Profile>",files.push({name:"profiles/"+profileName+".profile",content:profileBody}),packageXML+="<types><members>"+profileName+"</members><name>Profile</name></types>"}}}return packageXML+="<version>"+API_LEVEL+"</version></Package>",files.length?(files.push({name:"package.xml",content:packageXML}),debug.log("files",files),loadingMessage("Deploy profiles..."),writeFiles(files,function(err,blob){if(debug.log("writeFiles",err,blob),err)return loadingMessage(""),handleError("Unexpected error [5]: "+err);var reader=new FileReader;reader.readAsDataURL(blob),reader.onloadend=function(){base64data=reader.result;var deployOptions={};$client.deploy(base64data.split(",")[1],deployOptions,function(err,results){return debug.log("deploy",err,results),err?(loadingMessage(""),handleError("Unexpected error [6]: "+err)):checkDeployStatus(results.id,function(err,deployResult){if(debug.log("checkDeployStatus",err,deployResult),loadingMessage(""),err)return handleError("Unexpected error [6]: "+err);var url="http://"+server+"/changemgmt/monitorDeploymentsDetails.apexp?asyncId="+deployResult.id;if(deployResult.success){var msg='<h4>Deploy succesfully completed!</h4> <span>Click <a href="'+url+'" target="_blank">here</a> for more details.</span>';return handleMessageDialog(msg,function(){$G.window.document.location.reload()})}var msg='<h4>Deploy error :(</h4> Click <a href="'+url+'" target="_blank">here</a> for more details.</span>';return handleError(msg,function(){$G.window.document.location.reload()})})})}})):handleError("No change to be deployed.")}})},resetTemplates=function(){debug.log("Plugin storage: ",pluginStorage),$("#templateSlct").val(""),$("#saveAsInput").val(""),pluginStorage.loginHours.sort(function(a,b){return a&&a.name?b&&b.name?a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:a.created<b.created?-1:a.created>b.created?1:0:1:-1}),$("#templateSlct").empty(),$("#templateSlct").append($('<option value="">-- Select a template --</select>'));for(var i=0;i<pluginStorage.loginHours.length;i++){var lh=pluginStorage.loginHours[i],option=$("<option />");option.val(i).text(lh.name+" ["+new Date(lh.created).toLocaleString()+"]"),$("#templateSlct").append(option)}},removeTemplate=function(index){null!==index&&void 0!==index&&(pluginStorage.loginHours.splice(index,1),PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_PROFILE_CHAMBER,orgId,pluginStorage,function(err,ph){resetTemplates()}))},saveAsClick=function(isSaveNew){var template={name:$("#saveAsInput").val(),created:(new Date).getTime(),loginHours:{}};if(!isSaveNew){var ti=$("#templateSlct").val();if(!ti)return handleError("Select a template from the list to replace it [1].");if(template=pluginStorage.loginHours[parseInt(ti)],!template)return handleError("Select a template from the list to replace it [2].");template.loginHours={},template.created=(new Date).getTime()}if(!template.name)return handleError("Insert a valid template's name.");for(var pi=0;pi<profiles.length;pi++)if(!(selectedProfiles.length&&selectedProfiles.indexOf(pi.toString())<0)){var profile=profiles[pi],tmpLgHrs={};template.loginHours[profile.name]=tmpLgHrs;for(var di=0;di<DAYS_LIST.length;di++){var day=DAYS_LIST[di];if(!(selectedDays.length&&selectedDays.indexOf(day)<0)){var lh=profile.loginHours[day];if(lh){var lhTmp={};lhTmp.start=lh.start,lhTmp.end=lh.end,tmpLgHrs[day]=lhTmp}}}}isSaveNew&&pluginStorage.loginHours.push(template),debug.log("New template",template),PopupUtils.setPluginStorage($C.Plugins.$SFORG_PLUGIN_PROFILE_CHAMBER,orgId,pluginStorage,function(err,ph){resetTemplates()})},loadTemplate=function(template){if(template)for(var p=0;p<profiles.length;p++){var profile=profiles[p],profileTemp=template.loginHours[profile.name];if(profileTemp)for(var d=0;d<DAYS_LIST.length;d++){var day=DAYS_LIST[d],dayTemp=profileTemp[day];if(dayTemp){profile.loginHours[day]||(profile.loginHours[day]={}),profile.loginHours[day].updated=!0,profile.loginHours[day].oldStart=profile.loginHours[day].start,profile.loginHours[day].oldEnd=profile.loginHours[day].end,profile.loginHours[day].oldStart||0===profile.loginHours[day].oldStart||(profile.loginHours[day].oldStart=""),profile.loginHours[day].oldEnd||0===profile.loginHours[day].oldEnd||(profile.loginHours[day].oldEnd=""),profile.loginHours[day].start=dayTemp.start,profile.loginHours[day].end=dayTemp.end;var profileRow=$('tr[data-profile-id="'+p+'"]');profileRow.find('td.ui-profile-start[data-profile-day="'+day+'"]').addClass("changed").text(loginHourToString(dayTemp.start)),profileRow.find('td.ui-profile-end[data-profile-day="'+day+'"]').addClass("changed").text(loginHourToString(dayTemp.end)),profileRow.find("td.ui-profile span").text(profile.name+" *").addClass("changed")}}}},init=function(){loadingMessage("Loading profiles..."),chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){debug.log("tabs",tabs),PopupUtils.getCookieStoreFromTabId(tabs[0].id,function(storeId){debug.log("storeId",storeId),PopupUtils.getActiveSessions(null,storeId,function(err,sessions){return debug.log("getActiveSessions",err,sessions),err?handleError("Unexpected error [3]: "+err):(server=(sessions[orgId]||{}).domainAPI||null,sid=(sessions[orgId]||{}).sid||null,$("#oid").html(orgId),$("#server").html(server),server&&sid?($client=new $SalesforceClient.Client("https://"+server,sid,API_LEVEL),$("#deployBtn").click(deployBtnClick),$("#saveAsTemplateBtn").click(function(){saveAsClick(!0)}),$("#saveTemplateBtn").click(function(){saveAsClick(!1)}),$("#deleteTemplateBtn").click(function(){var selectedTemplateIndex=$("#templateSlct").val();selectedTemplateIndex&&removeTemplate(parseInt(selectedTemplateIndex))}),$("#loadTemplateBtn").click(function(){var selectedTemplateIndex=$("#templateSlct").val();if(selectedTemplateIndex){var template=pluginStorage.loginHours[parseInt(selectedTemplateIndex)];debug.log("selecte template",selectedTemplateIndex,template),loadTemplate(template)}}),PopupUtils.getPluginStorage($C.Plugins.$SFORG_PLUGIN_PROFILE_CHAMBER,orgId,function(err,data){pluginStorage=data||{},pluginStorage.loginHours||(pluginStorage.loginHours=[]),resetTemplates()}),void $client.listMetadata("Profile",function(err,results){return debug.log("listMetadata",err,results),err?handleError("Unexpected error [7]: "+err):void $client.retrieveMetadataType({Profile:results},function(err,data){return debug.log("retrieveMetadataType",err,data),err?handleError("Unexpected error [8]: "+err):err?void 0:checkStatus(data.id)})})):handleError("Unexpected error [4]: "+new Error("No valid session found")))})})})};return init()}),global.true=exports}({},function(){return this}());