/* ORGanizer for Salesforce - v10000.0.9.53 
 * Author: Enrico Murru (https://organizer.solutions/)
 * Copyright 2016-2024
 */
!function(exports,global){require(["jquery","global","constants","crypto","lz-string","popup-utils","justgage","backup-connector","licensing-utils","backup-utils","jquery-ui","bootstrap-modal","bootstrap-tab"],function(jQuery,$G,$C,CryptoJS,LZString,PopupUtils,JustGage,BackupConnector,$LicUtils,$BackupUtils){"use strict";var chrome=$G.chrome,window=$G.window,$=jQuery.noConflict();window&&window._gaq&&window._gaq.push(["_trackPageview"]);var debug=PopupUtils.newDebugger("Options");debug.log("Initialized, isContent? "+PopupUtils.isRunningContent()),$(function(){PopupUtils.handleCSSImageReferences();var encriptionEnabled=!1,currentPassword=null,shortcuts=(PopupUtils.isOSX(),null),tmpShortcuts=null,betaFeatures=null,apiLevel=null,_selectedTab=null;PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBetaFeatures],function(err,params){params&&params[PopupUtils.StorageParamNameBetaFeatures]&&params[PopupUtils.StorageParamNameBetaFeatures].DARK_MODE||$("body").removeClass("bnsn-dark")});var setOptionTabPanelVisiblity=function(){_selectedTab=PopupUtils.getURLParameter("tab");try{$('a[href="'+_selectedTab+'"]').tab("show"),_selectedTab=encodeURIComponent(_selectedTab)}catch(ex){debug.log(ex)}};setOptionTabPanelVisiblity(),$("#mainTabNav a").click(function(e){e.preventDefault(),$(this).tab("show"),_selectedTab=encodeURIComponent($(this).attr("href")),debug.log("_selectedTab:",_selectedTab)}),$("#faqLink").attr("href",$C.Endpoints.FAQPage),$("#organizerButtonHelp").attr("href",$C.Endpoints.FAQPage+"#orgButton"),$("#formulaHelp").attr("href",$C.Endpoints.FAQPage+"#formula"),$("#quickConsoleHelp").attr("href",$C.Endpoints.FAQPage+"#quickconsole"),$("#encryptionHelp").attr("href",$C.Endpoints.FAQPage+"#encryption"),$("#quotaHelp").attr("href",$C.Endpoints.FAQPage+"#quota"),$("#impexpHelp").attr("href",$C.Endpoints.FAQPage+"#impexp"),$("#backupHelp").attr("href",$C.Endpoints.FAQPage+"#backup"),$("#resetHelp").attr("href",$C.Endpoints.FAQPage+"#reset"),$("#shortcutsHelp").attr("href",$C.Endpoints.FAQPage+"#shortcuts"),$("#errorlogHelp").attr("href",$C.Endpoints.FAQPage+"#errorlog"),$("#quicklinkHelp").attr("href",$C.Endpoints.FAQPage+"#quicklogin"),$("#changesetHelp").attr("href",$C.Endpoints.FAQPage+"#changeset"),$("#apiLevelHelp").attr("href",$C.Endpoints.FAQPage+"#options"),$("#jsAPIsHelp").attr("href",$C.Endpoints.FAQPage+"#apis"),$("#quickLinksHelp").attr("href",$C.Endpoints.FAQPage+"#quicklinks"),$("a#proHelp").attr("href",$C.Endpoints.FAQPage+"#profeatures"),$("a#fieldHistoryHelp").attr("href",$C.Endpoints.FAQPage+"#history"),$("a#whitelistHelp").attr("href",$C.Endpoints.FAQPage+"#hidden"),$("a#buyLink").attr("href",$C.Endpoints.GoPro),$("i18n").each(function(){var elem=$(this),text=chrome.i18n.getMessage(elem.html()),parentAttribute=elem.attr("parent-attribute"),previousAttribute=elem.attr("previous-attribute");parentAttribute||previousAttribute?parentAttribute?(elem.parent().attr(parentAttribute,text),elem.remove()):previousAttribute&&(elem.prev().attr(previousAttribute,text),elem.remove()):elem.replaceWith(document.createTextNode(text))});var disableInterface=function(msg){$("#mainTabNav").before($('<p style="margin-top:40px" class="alert alert-danger"><strong>'+chrome.i18n.getMessage("general_err_modal_title")+"</strong> "+msg+"</p>")),$("button").attr("disabled",!0),$("#hardResetBtn").attr("disabled",!1),$("#localHardResetBtn").attr("disabled",!1),$(".ui-ok").attr("disabled",!1)},reloadPage=function(){var url=window.location.href;url=url.split("?")[0],url=url+"?tab="+_selectedTab,window.location.href=url},shortcutToString=function(combination){return PopupUtils.shortcutToString(combination)},checkValidShorcut=function(combination){var countKeys=0;return combination.alt&&countKeys++,combination.ctrl?countKeys++:combination.cmd&&countKeys++,!(countKeys<1||32!==combination.key&&(combination.key<48||combination.key>90))},handleError=function(msg,callback){$("#alertBox").find(".modal-body p").html(msg),$("#alertBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#alertBox").find(".ui-ok").focus()}).on("hidden.bs.modal",function(){return callback&&callback()})},handleConfirm=function(msg,callback,validateCallback){$("#dialogBox").find(".modal-body p").html(msg),$("#dialogBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#dialogBox").find(".ui-no").focus()}),callback&&($("#dialogBox").find(".ui-yes").unbind("click").click(function(){return validateCallback?validateCallback($("#dialogBox"),function(result){callback(result?!0:!1)}):void callback(!0)}),$("#dialogBox").find(".ui-no").unbind("click").click(function(){callback(!1)}))},handleMessageDialog=function(msg,callback){$("#messageBox").find(".modal-body p").html(msg),$("#messageBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#messageBox").find(".ui-ok").focus()}).on("hidden.bs.modal",function(){return callback&&callback()})},handleGenericModal=function(options,callback){return options?(options=options||{},options.title=options.title||"Info",$("#largeModal").find(".modal-title").text(options.title),$("#largeModal").find(".modal-body").html("").append(options.content),void $("#largeModal").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){}).on("hidden.bs.modal",function(){return callback&&callback()})):($("#largeModal").find(".modal-title").text(""),$("#largeModal").find(".modal-body").html(""),void $("#largeModal").modal("hide"))},handleLoadingMessage=function(msg){$("#loadingBox").find(".modal-body p").html(msg),$("#loadingBox").modal({keyboard:!1,backdrop:"static"}).modal(msg?"show":"hide")},handlePasswordRequest=function(msg,callback,useConfirmation){$("#passwordBox").find(".modal-body p").html(msg),$("#passwordBox "+(useConfirmation?"#encPassword2":"#encPassword")).val("").keypress(function(e){if(13==e.which)return $("#passwordBox").find(".ui-ok").trigger("click")}),useConfirmation||$("#encPassword2").parent().hide(),$("#passwordBox").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#passwordBox #encPassword").focus()}),callback&&($("#passwordBox").find(".ui-ok").unbind("click").click(function(){callback(!0,$("#passwordBox #encPassword").val(),$("#passwordBox #encPassword2").val())}),$("#passwordBox").find(".ui-cancel").unbind("click").click(function(){callback(!1)}))},handleBackupKeyRequest=function(callback){$("#backupKeyRequest #backupKey").val(""),$("#backupKeyRequest").keypress(function(e){if(13==e.which)return $("#backupKeyRequest").find(".ui-ok").trigger("click")}),$("#backupKeyRequest").modal({keyboard:!1,backdrop:"static"}).modal("show").on("shown.bs.modal",function(){$("#backupKeyRequest #backupKey").focus()}),callback&&($("#backupKeyRequest").find(".ui-ok").unbind("click").click(function(){return callback&&callback(!0,$("#backupKeyRequest #backupKey").val())}),$("#backupKeyRequest").find(".ui-cancel").unbind("click").click(function(){return callback&&callback(!1)}))},createGauge=function(domId,minVal,maxVal,val,title,label){var g=new JustGage({id:domId,value:val,min:minVal,max:maxVal,label:label||"",title:title});return g},handleClientsDeactivationPanel=function(licenseServerPayload){var panel=$("#clientDeactivationPanel").clone().remove().attr("id","clientDeactivationPanel2").show();panel.find("#serverMessage").text(licenseServerPayload.message),panel.find("#maxActiveClients").text(licenseServerPayload.details.maxActiveClients||"-"),panel.find("#deactivationFrequence").text(licenseServerPayload.details.deactivationTimeLimit||"-");var clientsTableBody=panel.find("table.active-clients-table tbody");for(var i in licenseServerPayload.details.clients){var client=licenseServerPayload.details.clients[i],tr=$("<tr/>");clientsTableBody.append(tr);var td1=$("<td/>").text(client.clientName).attr("title",client.clientName),td2=$("<td/>").text(client.clientID).attr("title",client.clientID),td3=$("<td/>").text(new Date(client.activationDate).toLocaleString()),td4=$("<td/>").text(client.os).attr("title",client.os),td5=$("<td/>").text(client.browser).attr("title",client.browser),td6=$("<td/>").text(client.extensionId).attr("title",client.extensionId),btnDisableClient=$('<button class="btn btn-warning btn-xs">Disable</button>');btnDisableClient.attr("data-client-index",i);var td7=$("<td/>").append(btnDisableClient);tr.append(td1).append(td2).append(td3).append(td4).append(td5).append(td6).append(td7),btnDisableClient.click(function(){var client=licenseServerPayload.details.clients[$(this).attr("data-client-index")];handleConfirm('Are you sure you want to disable client "'+client.clientName+'"?',function(result){result&&(handleLoadingMessage("Deactivating client..."),$("#consumeLicenseBtn").attr("data-client-to-deactivate",client.clientID).click(),handleGenericModal())})})}return handleGenericModal({content:panel,title:"Active Clients"})},switchEncryptionButtons=function(ecnEn){ecnEn?($("#encryptionYesBtn").removeClass("btn-default").addClass("active").addClass("btn-success"),$("#encryptionNoBtn").removeClass("active"),$("#timePasswordSection").show()):($("#encryptionYesBtn").removeClass("btn-success").removeClass("active").addClass("btn-default"),$("#encryptionNoBtn").addClass("active"),$("#timePasswordSection").hide())},switchGDriveBackup=function(gdribeEnabled){gdribeEnabled?($("#gdriveEnabled").removeClass("btn-default").addClass("active").addClass("btn-success"),$("#gdriveDisabled").removeClass("active")):($("#gdriveEnabled").removeClass("btn-success").removeClass("active").addClass("btn-default"),$("#gdriveDisabled").addClass("active"))},switchTimedSessionButton=function(pinConfiguration){if(pinConfiguration){$("#pinEnableBtn").removeClass("btn-default").addClass("active").addClass("btn-success").html(chrome.i18n.getMessage("opts_enc_btn_enabled"));var frequency=pinConfiguration[PopupUtils.StorageParamNamePinFrequency];frequency=parseInt(frequency),isNaN(frequency)&&(frequency=120),frequency<0&&(frequency=0),$("#tpFrequencyInput").val(frequency).attr("disabled",!1),$("#tpFrequencyInputLbl").show(),$("#saveTimedPasswordBtn").show()}else $("#tpFrequencyInput").val("").hide(),$("#tpFrequencyInputLbl").hide(),$("#saveTimedPasswordBtn").hide(),$("#pinEnableBtn").removeClass("btn-success").removeClass("active").addClass("btn-default").html(chrome.i18n.getMessage("opts_enc_btn_disabled"))},handlePasswordEncryption=function(encryptionOldEnabled,pwd,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts],function(err,params){if(err)return callback&&callback(err);for(var accounts=params[PopupUtils.StorageParamNameAccounts]||[],i=0;i<accounts.length;i++){var acc=accounts[i];if(encryptionOldEnabled)acc.p=PopupUtils.decryptText(acc.p,pwd),acc.p=PopupUtils.obfuscate(acc.p);else{var tmp=acc.p;acc.p=PopupUtils.deobfuscate(acc.p),acc.p||(acc.p=tmp),acc.p=PopupUtils.encryptText(acc.p,pwd)}}PopupUtils.setSyncPassphrase(encryptionOldEnabled?null:pwd,function(err){return err?callback&&callback(err):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameAccounts,accounts,function(err){return err?callback&&callback(err):callback(null)})})})},loadInAppPurchasePanel=function(callback){var forceRefresh="true"===PopupUtils.getURLParameter("force");if(debug.log("Force refresh products: ",forceRefresh),forceRefresh){var queryParams=new URLSearchParams(window.location.search);queryParams.delete("force"),history.replaceState(null,null,"?"+queryParams.toString())}debug.log("Calling BKG-REFRESH-PURCHASED-PRODUCTS..."),chrome.runtime.sendMessage({action:"BKG-REFRESH-PURCHASED-PRODUCTS",forceRefresh:forceRefresh},function(rslt){debug.log(rslt);var err=rslt.error,purchLst=rslt.purchasedProducts;debug.log("refreshPurchasedProducts() : ",err,purchLst);var appliedPromoSection=$("#appliedPromoSection"),promoBody=appliedPromoSection.find("#promoListTable");$("#promoListTable").html("");for(var i=0;i<(purchLst||[]).length;i++){var product=purchLst[i];if("promo"===product.kind){appliedPromoSection.show(),debug.log("PROMO CODE: ",product);var tr=$("<tr />").addClass("text-success").attr("data-sku",product.sku),tdPromoCode=$('<td class="ui-promo"/>').text(product.itemId).attr("data-promo-code",product.itemId),promoType=PopupUtils.getPromoCodeType(product.itemId),tdPrType=$('<td class="ui-promo-type"/>').text(promoType),tdPrCode=$('<td class="ui-sku"/>').text(product.sku),tdPrExpiration=$('<td class="ui-expiration"/>').text(product.expiration),tdPrStatus=$('<td class="ui-state"/>').text(product.state),tdPrAction=$('<td class="ui-action"/>');if(promoType===$C.PromoCodes.GUMROAD_PROMO_TYPE&&product.manageUrl){var manageLicenseBtn=$('<button class="btn btn-primary btn-sm">Manage</button>').attr("data-manage-url",product.manageUrl).attr("title","Manage Gumroad subscription").click(function(){window.open($(this).attr("data-manage-url"))});tdPrAction.append(manageLicenseBtn)}var removeBtn=$('<button class="btn btn-danger btn-sm">Remove</button>');removeBtn.click(function(){var tr=$(this).parent().parent(),promoCode=tr.find("td.ui-promo").attr("data-promo-code");handleConfirm("Do you really want to remove this promo code? <br/>You can still reapply it later in case of misclick.",function(doConfirm){doConfirm&&(handleLoadingMessage("Removing license..."),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,function(err,params){if(err)return callback&&callback(err+" [1]");for(var param=params[PopupUtils.StorageParamNamePromoCodes]||[],promoIndex=-1,li=0;li<param.length;li++)if(param[li].licenseKey===promoCode){promoIndex=li;break}return promoIndex>=0&&param.splice(promoIndex,1),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,param,function(err){return err?callback&&callback(err+"[2]"):PopupUtils.loadAjaxCache(function(cache){return cache=cache||{},cache.purchasedProducts=[],PopupUtils.storeAjaxCache(cache,function(){return PopupUtils.syncData({noQuotaCheck:!0},function(err){return err?(PopupUtils.logError(err),handleError(err)):chrome.runtime.sendMessage({action:"BKG-REFRESH-PURCHASED-PRODUCTS",forceRefresh:!0},function(rslt){return reloadPage()})})})})})}))})}),tdPrAction.append(removeBtn),tr.append(tdPromoCode).append(tdPrType).append(tdPrCode).append(tdPrExpiration).append(tdPrStatus).append(tdPrAction),promoBody.append(tr)}}return callback&&callback()})},initUI=function(){switchEncryptionButtons(encriptionEnabled),$("#encryptionYesBtn").click(function(){$(this).hasClass("active")||handlePasswordRequest(chrome.i18n.getMessage("opts_pwd_message_new_pwd"),function(success,password,password2){if(success){if(password=(password||"").trim(),password2=(password2||"").trim(),!password)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_set_valid_pwd")));if(password!=password2)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_pwds_dont_match")));saveEncryption(!0,password)}},!0)}),$("#encryptionNoBtn").click(function(){$(this).hasClass("active")||handlePasswordRequest(chrome.i18n.getMessage("opts_pwd_message_type_current_pwd"),function(success,password){if(success){if(password=(password||"").trim(),!password)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_set_valid_pwd")));if(currentPassword!==password)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_message_invalid_password")));saveEncryption(!1,password)}})});var triggerTimedPassword=function(isEnabling){handlePasswordRequest(chrome.i18n.getMessage("opts_pwd_message_type_current_pwd"),function(success,password){if(success){if(password=(password||"").trim(),!password)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_set_valid_pwd")));if(console.log(currentPassword,password),currentPassword!==password)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_message_invalid_password")));if(isEnabling){var frequency=$("#tpFrequencyInput").val();frequency=parseInt(frequency),isNaN(frequency)&&(frequency=120),frequency<0&&(frequency=0);var lastCheckTime=(new Date).getTime(),pinConf={};pinConf[PopupUtils.StorageParamNamePinLastCheckTime]=lastCheckTime,pinConf[PopupUtils.StorageParamNamePinFrequency]=frequency,PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePin,pinConf,function(err,params){reloadPage()})}else PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePin,null,function(err,params){reloadPage()})}})};$("#pinEnableBtn").click(function(){var isEnabling=!$(this).hasClass("active");triggerTimedPassword(isEnabling)}),$("#saveTimedPasswordBtn").click(function(){var isEnabling=$("#pinEnableBtn").hasClass("active");triggerTimedPassword(isEnabling)});var saveEncryption=function(enabledEnc,newPassword){!!enabledEnc!=!!encriptionEnabled&&handleConfirm(chrome.i18n.getMessage(enabledEnc?"opts_pwd_message_do_u_want_to_enable_enc":"opts_pwd_message_do_u_want_to_disable_enc"),function(result){if(!result)return void reloadPage();if(enabledEnc&&!newPassword)return handleError(new Error(chrome.i18n.getMessage("opts_pwd_message_invalid_password")));var newPwdToBeStored=enabledEnc?newPassword:null,passwordToProcessRecords=enabledEnc?newPwdToBeStored:currentPassword;return PopupUtils.setLocalPassphrase(newPwdToBeStored,function(err){return err?(PopupUtils.logError(err),handleError(err)):handlePasswordEncryption(!enabledEnc,passwordToProcessRecords,function(err){return err?(PopupUtils.logError(err),handleError(err)):PopupUtils.syncData({noBackup:!0,noQuotaCheck:!0},function(err){return err?(PopupUtils.logError(err),handleError(err)):PopupUtils.updateBackupPasswords(currentPassword,newPwdToBeStored,function(){reloadPage()})})})})})};$("#gdriveEnabled, #gdriveDisabled").on("click",function(){if(!$(this).hasClass("active")){var gdriveBackupEnablement=!$("#gdriveEnabled").hasClass("active");return handleConfirm("By "+(gdriveBackupEnablement?"enabling":"disabling")+" Google Drive backup, a background job will "+(gdriveBackupEnablement?"":"no longer")+" periodically upload a backup remotely.<br/>Do you wish to continue?",function(result){if(result)return PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,function(err,params){return err?(PopupUtils.logError(err),handleError(err)):(params=(params||{})[PopupUtils.StorageParamNameBetaFeatures],betaFeatures.GDRIVE_SYNC={BACKUP_ENABLED:gdriveBackupEnablement},debug.log("betaFeatures",betaFeatures.GDRIVE_SYNC.BACKUP_ENABLED),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,betaFeatures,function(err){return err?(PopupUtils.logError(err),handleError(err)):PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBackgroundSyncStatus,null,function(err){var promise=chrome.runtime.sendMessage({action:"BKG-SYNC",forceSync:!0,overrideRemote:!0});$G.isFirefox&&promise?promise.then(function(){reloadPage()}):reloadPage()})}))})})}}),$("#btnSaveBetaSettingsTop, #btnSaveBetaSettingsBottom").on("click",function(){PopupUtils.trackAnalyticsEvent("#btnSaveBetaSettings","Popup action");var oldGDRIVE_SYNC=betaFeatures.GDRIVE_SYNC;betaFeatures={},betaFeatures.GDRIVE_SYNC=oldGDRIVE_SYNC,betaFeatures.QUICK_CONSOLE=$("#chkBetaQuickConsole").is(":checked"),betaFeatures.FORMULA_EDITOR=$("#chkBetaFormulaEditor").is(":checked"),betaFeatures.MAGIC_BUTTON=$("#chkBetaMagicButton").is(":checked"),betaFeatures.MAGIC_BUTTON_OPTIONS={orientation:$("#slctMagicButtonOrientation").val(),position:parseInt($("#slideMagicButtonPosition").val()||"0")},betaFeatures.DARK_MODE=$("#chkDarkMode").is(":checked"),betaFeatures.DEBUGGING=$("#chkBetaDebugging").is(":checked"),betaFeatures.FIELD_HISTORY=$("#chkFieldHistory").is(":checked"),betaFeatures.WHITELIST_IPS=$("#chkWhitelist").is(":checked"),betaFeatures.FORMULA_EDITOR_OPTIONS={TAB_SIZE:$("#_inputTabSize").val()},betaFeatures.QUICKLOGIN=$("#chkBetaQuicklogin").is(":checked"),betaFeatures.QUICKLOGIN_OPTIONS={},betaFeatures.CHANGESET_HELPER=!!$("#chkBetaCSHelper").is(":checked")&&$("#slctChangeSetHelperVersion").val(),betaFeatures.CHANGESET_HELPER_OPTIONS={},betaFeatures.JS_APIS_OPTIONS={ENABLED:!1};var quickLinksCommandOrder=[];$("#qlCommandOrder option").each(function(){quickLinksCommandOrder.push($(this).val())}),betaFeatures.QUICKLINKS_OPTIONS={COMMANDS_ORDER:quickLinksCommandOrder},apiLevel=$("#slctApiLevel").val(),/^[0-9]{2}\.0$/.test(apiLevel||"")||(apiLevel=$C.SF_API.LEVEL),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBetaFeatures,betaFeatures,function(err){return err?(PopupUtils.logError(err),handleError(err)):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameApiLevel,apiLevel,function(err){return err?(PopupUtils.logError(err),handleError(err)):void PopupUtils.syncData({noQuotaCheck:!0},function(err){return err?(PopupUtils.logError(err),handleError(err)):void reloadPage()})})})}),$("#downloadLogBtn").click(function(){PopupUtils.getLoggedErrors(function(err,logList){if(err)return PopupUtils.logError(err),handleError("Unexpected error: "+err);var filename="debug-logs-"+(new Date).toISOString().replace(/\:/g,"-")+".log";PopupUtils.triggerDownloadTextFile(filename,"text/log",logList)})}),$("#exportBtn, #exportBtnBkp").click(function(){var _storedPassPhrase=null,exportJson="json"===$(this).attr("data-export"),executeExport=function(){var options={localPassPhrase:_storedPassPhrase,handleCompression:!exportJson};PopupUtils.exportManualBackup(options,function(err){if(err)return handleError(err)})};PopupUtils.getLocalPassphrase(function(err,pwd){return err?callback&&callback(err):(_storedPassPhrase=pwd||null,void(_storedPassPhrase?handlePasswordRequest("Type current password: ",function(success,password){if(success)return password?_storedPassPhrase!==password?handleError("Invalid password, try again."):executeExport():handleError("Set a valid password.")}):executeExport()))})});var _loadedImportFile=null,_loadedImportFileExt=null;$("#importFile").change(function(evt){var input=evt.target;if(input.files&&input.files.length){var reader=new FileReader;reader.onload=function(){if(_loadedImportFile=reader.result,input.files&&input.files.length){var nameSplit=input.files[0].name.split(".");_loadedImportFileExt=nameSplit[nameSplit.length-1]}},reader.readAsText(input.files[0])}}),$("#importBtn").click(function(){function importData(){var options={localPassPhrase:_storedPassPhrase,handleCompression:_loadedImportFileExt.indexOf("bkp")>=0,backupContent:_loadedImportFile};PopupUtils.importManualBackup(options,function(err){return err?handleError(err):void reloadPage()})}var _storedPassPhrase=null;handleConfirm("Every other configuration will be deleted. Are you sure to continue?",function(result){result&&PopupUtils.getLocalPassphrase(function(err,pwd){return err?(PopupUtils.logError(err),handleError(err)):(_storedPassPhrase=pwd||null,importData())})})}),$("#saveSCBtn").click(function(){PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameShortcuts,tmpShortcuts,function(err){return err?(PopupUtils.logError(err),handleError(err)):void PopupUtils.syncData({noQuotaCheck:!0},function(err){return err?(PopupUtils.logError(err),handleError(err)):void reloadPage()})})}),$("#hardResetBtn").click(function(){var confirmText="Yes, I want to reset all data!";handleConfirm("Are you sure you want to reset all your local/synched data?<br/><br/><small>Write <b>"+confirmText+'</b> on the following input text and then click the Yes button.</small><br/><br/><input class="form-control input-sm ui-reset-check-text" placeholder="'+confirmText+'"/>',function(result){result&&PopupUtils.hardReset(function(err){return err?(PopupUtils.logError(err),handleError("Unexpected error. Please retry.")):void reloadPage()})},function(element,next){return element.find(".ui-reset-check-text").val()!==confirmText?(next&&next(!1),handleError("Confirm text doesn't match. Retry.",function(){$("#hardResetBtn").trigger("click")})):next&&next(!0)})}),$("#localHardResetBtn").click(function(){var confirmText="Yes, I want to reset my local data!";handleConfirm("Are you sure you want to reset all your local data?<br/><br/><small>Write <b>"+confirmText+'</b> on the following input text and then click the Yes button.</small><br/><br/><input class="form-control input-sm ui-reset-check-text" placeholder="'+confirmText+'"/>',function(result){result&&chrome.storage.local.clear(function(err){return err?(PopupUtils.logError(err),handleError("Unexpected error. Please retry.")):void reloadPage()})},function(element,next){return element.find(".ui-reset-check-text").val()!==confirmText?(next&&next(!1),handleError("Confirm text doesn't match. Retry.",function(){$("#localHardResetBtn").trigger("click")})):next&&next(!0)})}),$("#btnResetQuickConsoleSize").click(function(){PopupUtils.setConfigParameterLocal("WIN_POS",null,function(){reloadPage()})}),$("#btnBackupVIQnVIS").click(function(){var backup={};PopupUtils.getGlobalPluginStorage($C.Plugins.$SFORG_PLUGIN_00002,function(err,data){backup.queries=data.queries||[],PopupUtils.getGlobalPluginStorage($C.Plugins.$SFORG_PLUGIN_00003,function(err,data2){backup.scripts=data2.scripts||[],PopupUtils.triggerDownloadTextFile("viq_n_vis_"+(new Date).toISOString().replace(/\:/g,"-")+".json","text/json",JSON.stringify(backup,null,2))})})}),$("#btnResetBackgroundDescribe").click(function(){chrome.runtime.sendMessage({action:"BKG-RESET-DESCRIBE"}),handleMessageDialog("Background describes reset completed!")}),$("#qlCommandOrderUpBtn").click(function(){for(var options=$("#qlCommandOrder option"),i=1;i<options.length;i++){var opt=$(options[i]),optBefore=$(options[i-1]);opt.is(":selected")&&(optBefore.is(":selected")||(opt.insertBefore(optBefore),options=$("#qlCommandOrder option")))}}),$("#qlCommandOrderDownBtn").click(function(){for(var options=$("#qlCommandOrder option"),i=options.length-2;i>=0;i--){var opt=$(options[i]),optAfter=$(options[i+1]);opt.is(":selected")&&(optAfter.is(":selected")||optAfter.is(":disabled")||(opt.insertAfter(optAfter),options=$("#qlCommandOrder option")))}}),$(window).on("keydown",function(e){if(tmpShortcuts){var scObject={alt:e.altKey,ctrl:e.ctrlKey,cmd:e.metaKey,shift:e.shiftKey,key:e.keyCode},str=shortcutToString(scObject);$("#scOpenOrgs").is(":focus")?(e.preventDefault(),$("#scOpenOrgs").val(str),tmpShortcuts.sc1=scObject):$("#scOpenAccounts").is(":focus")?(e.preventDefault(),$("#scOpenAccounts").val(str),tmpShortcuts.sc2=scObject):$("#scCreateAccount").is(":focus")?(e.preventDefault(),$("#scCreateAccount").val(str),tmpShortcuts.sc3=scObject):$("#scOpenHome").is(":focus")?(e.preventDefault(),$("#scOpenHome").val(str),tmpShortcuts.sc4=scObject):$("#scOpenSetup").is(":focus")?(e.preventDefault(),$("#scOpenSetup").val(str),tmpShortcuts.sc5=scObject):$("#scOpenDevConsole").is(":focus")?(e.preventDefault(),$("#scOpenDevConsole").val(str),tmpShortcuts.sc6=scObject):$("#scOpenQuickLinks").is(":focus")?(e.preventDefault(),$("#scOpenQuickLinks").val(str),tmpShortcuts.sc7=scObject):$("#scOpenQuickConsole").is(":focus")?(e.preventDefault(),$("#scOpenQuickConsole").val(str),tmpShortcuts.sc8=scObject):$("#scAutocomplete").is(":focus")&&(e.preventDefault(),$("#scAutocomplete").val(str),tmpShortcuts.sc9=scObject);for(var i=0;i<tmpShortcuts.scPlugins.length;i++)$("#scPlugins"+(i+1)).is(":focus")&&(e.preventDefault(),$("#scPlugins"+(i+1)).val(str),tmpShortcuts.scPlugins[i]=scObject);for(var i=0;i<tmpShortcuts.scPluginsAction.length;i++)$("#scPluginsAction"+(i+1)).is(":focus")&&(e.preventDefault(),$("#scPluginsAction"+(i+1)).val(str),tmpShortcuts.scPluginsAction[i]=scObject,tmpShortcuts.scPluginsAction[i].active=!0)}});var changeGoogleAuthButtonStateCallback=function(err,profileInfo){return debug.log("changeGoogleAuthButtonStateCallback",err,profileInfo),$("#authGoogle").show(),$("#loadingAuthorizationLbl").hide(),err&&profileInfo.interactive?(handleLoadingMessage(""),handleError("Authorization process interrupted: "+err)):($("#authGoogleDiv").show(),void(!err&&profileInfo.email&&($("#authGoogle").addClass("disabled").unbind("click"),$("#authGoogleDetailsTxt").text("Authenticated as "+profileInfo.email),profileInfo.interactive&&reloadPage())))};$("#authGoogle").click(function(){handleLoadingMessage("Authorizing user..."),$LicUtils.handleOAuthWebFlow(!0,changeGoogleAuthButtonStateCallback)}),$("#unauthorizeAuthBtn").click(function(){handleConfirm("Are you sure you want to unauthorized current user? Any GDrive connection will be lost.",function(isOk){isOk&&(handleLoadingMessage("Revoking user authorizations..."),$LicUtils.clearCachedTokens(function(err){err&&debug.error(err)}))})}),loadInAppPurchasePanel(function(){handleLoadingMessage(),PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameOrgs,PopupUtils.StorageParamNameShortcuts,PopupUtils.StorageParamNameBetaFeatures,PopupUtils.StorageParamNameMaxBackupsNum,PopupUtils.StorageParamNameBackupsLocalStorage,PopupUtils.StorageParamNamePin,PopupUtils.StorageParamNameAccountGroupSorted,PopupUtils.StorageParamNameApiLevel,PopupUtils.StorageParamNameApiCounter,PopupUtils.StorageParamNameApiCounterDate,PopupUtils.StorageParamNameBackgroundBackupStatus,PopupUtils.StorageParamNameGDriveBackupError,PopupUtils.StorageParamNameClientName,PopupUtils.StorageParamNameEnableAPIMonitorDetails,PopupUtils.StorageParamNameWorkerSyncStatus],function(err,params){if(err)return PopupUtils.logError(err),handleError(err);params||(params={}),$LicUtils.handleOAuthWebFlow(!1,changeGoogleAuthButtonStateCallback);var gdriveBackupStatusDetails=(params||{})[PopupUtils.StorageParamNameBackgroundBackupStatus]||{},gdriveBackupStatus=(params||{})[PopupUtils.StorageParamNameGDriveBackupError]||null,apiUsageTotal=params[PopupUtils.StorageParamNameApiCounter]||0,apiUsageDate=params[PopupUtils.StorageParamNameApiCounterDate]||(new Date).getTime(),apiDetailsEnabled=!!params[PopupUtils.StorageParamNameEnableAPIMonitorDetails],storedParamsAccounts=params[PopupUtils.StorageParamNameAccounts]||[],storedParamsOrgs=params[PopupUtils.StorageParamNameOrgs]||[],maxBackupsNum=params[PopupUtils.StorageParamNameMaxBackupsNum]||PopupUtils.MaxBackupNumDefault,backups=params[PopupUtils.StorageParamNameBackupsLocalStorage]||[];shortcuts=params[PopupUtils.StorageParamNameShortcuts]||PopupUtils.DefaultShortcuts,shortcuts.scPlugins||(shortcuts.scPlugins=PopupUtils.DefaultShortcuts.scPlugins),shortcuts.scPluginsAction||(shortcuts.scPluginsAction=PopupUtils.DefaultShortcuts.scPluginsAction),betaFeatures=params[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault,apiLevel=params[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL;var pinCongiguration=params[PopupUtils.StorageParamNamePin]||null;switchTimedSessionButton(pinCongiguration);var clientName=params[PopupUtils.StorageParamNameClientName];clientName||(clientName="My laptop",PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameClientName,clientName));var workerSyncStatus=params[PopupUtils.StorageParamNameWorkerSyncStatus]||{},syncMsg="OK";workerSyncStatus.errorMessage?$("#lblSyncStorageMsg").addClass("text-danger"):workerSyncStatus.passwordRequest?$("#lblSyncStorageMsg").addClass("text-warning"):$("#lblSyncStorageMsg").addClass("text-success"),$("#lblSyncStorageMsg").text(syncMsg),$("#lblSyncStorageLastCheck").text(new Date(workerSyncStatus.lastCheck).toLocaleString());var otherParams={};otherParams[PopupUtils.StorageParamNameShortcuts]=shortcuts,otherParams[PopupUtils.StorageParamNameBetaFeatures]=JSON.stringify(betaFeatures),otherParams[PopupUtils.StorageParamNameAccountGroupSorted]=JSON.stringify(params[PopupUtils.StorageParamNameAccountGroupSorted]||[]),otherParams[PopupUtils.StorageParamNameApiLevel]=apiLevel||$C.SF_API.LEVEL;var params=PopupUtils.createSynchedMap(storedParamsOrgs,storedParamsAccounts,otherParams),result=PopupUtils.calculateSyncMapSize(params),size=result.size/PopupUtils.MaxSyncStorageBytes()*100;debug.log("INIT PopupUtils.calculateSyncMapSize",result,size+"%"),createGauge("dataGauge",0,100,size,chrome.i18n.getMessage("opts_gauge_total_sync_quota"),"%"),
createGauge("itemsGauge",0,PopupUtils.MaxSyncStorageItems(),result.itemsCount,chrome.i18n.getMessage("opts_gauge_total_sync_items")),PopupUtils.getLicenseLimits(null,function(err,licenseLimits){if(err)return PopupUtils.logError(err);debug.log("licenseLimits",licenseLimits),$("#licenseType").text(licenseLimits.license),licenseLimits.GDRIVE_SYNC?($("#gdriveBackupPanel").show(),$("#gdriveBackupPanelNoPro").remove()):($("#gdriveBackupPanel").remove(),$("#gdriveBackupPanelNoPro").show()),licenseLimits.BACKUP_CONNECTOR?($("#backupAppPanelContainer").show(),$("#backupAppPanelContainerNoPro").remove()):($("#backupAppPanelContainer").remove(),$("#backupAppPanelContainerNoPro").show());var synchedAccounts=[];for(var ai in storedParamsAccounts)storedParamsAccounts[ai].s&&synchedAccounts.push(storedParamsAccounts[ai]);createGauge("synchedAccountsGauge",0,licenseLimits.MAX_SF_SINCHED_ACCOUNTS,synchedAccounts.length,chrome.i18n.getMessage("opts_gauge_total_sync_accounts")),createGauge("localAccountsGauge",0,licenseLimits.MAX_SF_ACCOUNTS,storedParamsAccounts.length,chrome.i18n.getMessage("opts_gauge_total_accounts"))}),chrome.storage.local.get(null,function(params){var localStorageLimitPerc=1*JSON.stringify(params).length/(1*PopupUtils.MaxLocalStorageItemBytes())*100;createGauge("localDataGauge",0,100,localStorageLimitPerc,chrome.i18n.getMessage("opts_gauge_local_storage"),"%")}),tmpShortcuts=JSON.parse(JSON.stringify(shortcuts)),tmpShortcuts.sc8||(tmpShortcuts.sc8=PopupUtils.DefaultShortcuts.sc8),tmpShortcuts.quickLinkCommand||(tmpShortcuts.quickLinkCommand=PopupUtils.DefaultShortcuts.quickLinkCommand),$("#lnkForceResync").click(function(){handleLoadingMessage("Syncing data..."),chrome.runtime.sendMessage({action:"BKG-SYNC"},function(rslt){return handleLoadingMessage(""),handleMessageDialog("Data succesfully synchronized!",function(){return reloadPage()})})}),$("#btnEditClientName").click(function(){$("#btnSaveClientName").show(),$(this).hide(),$("#txtClientName").attr("readonly",!1)}),$("#txtClientName").val(clientName),PopupUtils.getLocalCode(function(uc){$("#txtClientID").val(uc)}),$("#btnSaveClientName").click(function(){var clientName=($("#txtClientName").val()||"").substring(0,50);clientName||(clientName="My "+$G.detectOS(navigator.userAgent)+" laptop"),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameClientName,clientName),$("#btnSaveClientName").hide(),$("#btnEditClientName").show(),$("#txtClientName").attr("readonly",!0),window.location.href="?force=true"}),$("#apiUsageDate").text(new Date(apiUsageDate).toLocaleDateString()+" "+new Date(apiUsageDate).toLocaleTimeString()),$("#apiUsageTotal").text(apiUsageTotal),$("#chkToggleDetails").attr("checked",apiDetailsEnabled),$("#gdriveBackupMsgLbl").text(gdriveBackupStatus||"OK").addClass(gdriveBackupStatus?"text-danger":"text-success");var gdriveBackupLastUpdated=new Date(gdriveBackupStatusDetails.lastUpdated||null).toLocaleString();$("#gdriveBackupStatusLbl").text((gdriveBackupStatusDetails.md5||"backup not started yet.")+(gdriveBackupStatusDetails.lastUpdated?" ("+gdriveBackupLastUpdated+")":"")),$("#scOpenOrgs").val(shortcutToString(tmpShortcuts.sc1)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc1)||(tmpShortcuts.sc1=shortcuts.sc1,$(this).val(shortcutToString(tmpShortcuts.sc1)))}),$("#scOpenAccounts").val(shortcutToString(tmpShortcuts.sc2)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc2)||(tmpShortcuts.sc2=shortcuts.sc2,$(this).val(shortcutToString(tmpShortcuts.sc2)))}),$("#scCreateAccount").val(shortcutToString(tmpShortcuts.sc3)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc3)||(tmpShortcuts.sc3=shortcuts.sc3,$(this).val(shortcutToString(tmpShortcuts.sc3)))}),$("#scOpenHome").val(shortcutToString(tmpShortcuts.sc4)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc4)||(tmpShortcuts.sc4=shortcuts.sc4,$(this).val(shortcutToString(tmpShortcuts.sc4)))}),$("#scOpenSetup").val(shortcutToString(tmpShortcuts.sc5)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc5)||(tmpShortcuts.sc5=shortcuts.sc5,$(this).val(shortcutToString(tmpShortcuts.sc5)))}),$("#scOpenDevConsole").val(shortcutToString(tmpShortcuts.sc6)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc6)||(tmpShortcuts.sc6=shortcuts.sc6,$(this).val(shortcutToString(tmpShortcuts.sc6)))}),$("#scOpenQuickLinks").val(shortcutToString(tmpShortcuts.sc7)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc7)||(tmpShortcuts.sc7=shortcuts.sc7,$(this).val(shortcutToString(tmpShortcuts.sc7)))}),$("#scOpenQuickConsole").val(shortcutToString(tmpShortcuts.sc8)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc8)||(tmpShortcuts.sc8=shortcuts.sc8,$(this).val(shortcutToString(tmpShortcuts.sc8)))}),$("#scAutocomplete").val(shortcutToString(tmpShortcuts.sc9)).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.sc9)||(tmpShortcuts.sc9=shortcuts.sc9,$(this).val(shortcutToString(tmpShortcuts.sc9)))}),$("#scQuickLinkCommand").val(tmpShortcuts.quickLinkCommand).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){$(this).removeClass("ui-input-sc-focus"),tmpShortcuts.quickLinkCommand=$(this).val(),tmpShortcuts.quickLinkCommand||(tmpShortcuts.quickLinkCommand=shortcuts.quickLinkCommand,$(this).val(tmpShortcuts.quickLinkCommand))});for(var i=0;i<shortcuts.scPlugins.length;i++)$("#scPlugins"+(i+1)).attr("data-index",i).val(shortcutToString(tmpShortcuts.scPlugins[i])).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){var index=parseInt($(this).attr("data-index"));$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.scPlugins[index])||(tmpShortcuts.scPlugins[index]=shortcuts.scPlugins[index],$(this).val(shortcutToString(tmpShortcuts.scPlugins[index])))});for(var i=0;i<shortcuts.scPluginsAction.length;i++)$("#scPluginsAction"+(i+1)).attr("data-index",i).val(shortcutToString(tmpShortcuts.scPluginsAction[i])).focus(function(){$(this).addClass("ui-input-sc-focus")}).blur(function(){var index=parseInt($(this).attr("data-index"));$(this).removeClass("ui-input-sc-focus"),checkValidShorcut(tmpShortcuts.scPluginsAction[index])||(tmpShortcuts.scPluginsAction[index]=shortcuts.scPluginsAction[index],$(this).val(shortcutToString(tmpShortcuts.scPluginsAction[index])))});if($("#resetSCBtn").click(function(){tmpShortcuts=JSON.parse(JSON.stringify(shortcuts)),$("#scOpenOrgs").val(shortcutToString(tmpShortcuts.sc1)),$("#scOpenAccounts").val(shortcutToString(tmpShortcuts.sc2)),$("#scCreateAccount").val(shortcutToString(tmpShortcuts.sc3)),$("#scOpenHome").val(shortcutToString(tmpShortcuts.sc4)),$("#scOpenSetup").val(shortcutToString(tmpShortcuts.sc5)),$("#scOpenDevConsole").val(shortcutToString(tmpShortcuts.sc6)),$("#scOpenQuickLinks").val(shortcutToString(tmpShortcuts.sc7)),$("#scOpenQuickConsole").val(shortcutToString(tmpShortcuts.sc8)),$("#scAutocomplete").val(shortcutToString(tmpShortcuts.sc9)),$("#scQuickLinkCommand").val(tmpShortcuts.quickLinkCommand);for(var i=0;i<tmpShortcuts.scPlugins.length;i++)$("#scPlugins"+(i+1)).val(shortcutToString(tmpShortcuts.scPlugins[i])),tmpShortcuts.scPluginsAction[i].active&&$("#scPluginsAction"+(i+1)).val(shortcutToString(tmpShortcuts.scPluginsAction[i]))}),debug.log("BETA",betaFeatures),betaFeatures.QUICK_CONSOLE?$("#chkBetaQuickConsole").prop("checked",!0):$("#chkBetaQuickConsole").prop("checked",!1),betaFeatures.FORMULA_EDITOR?$("#chkBetaFormulaEditor").prop("checked",!0):$("#chkBetaFormulaEditor").prop("checked",!1),betaFeatures.MAGIC_BUTTON===!0?$("#chkBetaMagicButton").prop("checked",!0):$("#chkBetaMagicButton").prop("checked",!1),$("#chkDarkMode").prop("checked",betaFeatures.DARK_MODE===!0),betaFeatures.JS_APIS_OPTIONS&&$("#chkJSApis").prop("checked",!1),betaFeatures.MAGIC_BUTTON_OPTIONS&&betaFeatures.MAGIC_BUTTON_OPTIONS.orientation&&$("#slctMagicButtonOrientation").val(betaFeatures.MAGIC_BUTTON_OPTIONS.orientation),$("#slideMagicButtonPosition").val("0"),betaFeatures.MAGIC_BUTTON_OPTIONS&&betaFeatures.MAGIC_BUTTON_OPTIONS.position&&$("#slideMagicButtonPosition").val(betaFeatures.MAGIC_BUTTON_OPTIONS.position),$("#slideMagicButtonPosition").on("change",function(){$("#_orgBtnPosition").html($(this).val())}).on("input",function(){$("#_orgBtnPosition").html($(this).val())}),$("#_orgBtnPosition").html($("#slideMagicButtonPosition").val()),betaFeatures.DEBUGGING?$("#chkBetaDebugging").prop("checked",!0):$("#chkBetaDebugging").prop("checked",!1),void 0===betaFeatures.FIELD_HISTORY&&(betaFeatures.FIELD_HISTORY=!0),betaFeatures.FIELD_HISTORY?$("#chkFieldHistory").prop("checked",!0):$("#chkFieldHistory").prop("checked",!1),void 0===betaFeatures.WHITELIST_IPS&&(betaFeatures.WHITELIST_IPS=!1),betaFeatures.WHITELIST_IPS?$("#chkWhitelist").prop("checked",!0):$("#chkWhitelist").prop("checked",!1),betaFeatures.QUICKLOGIN?$("#chkBetaQuicklogin").prop("checked",!0):$("#chkBetaQuicklogin").prop("checked",!1),betaFeatures.QUICKLINKS_OPTIONS){var order=betaFeatures.QUICKLINKS_OPTIONS.COMMANDS_ORDER;if(order&&order.length)for(var slct=$("#qlCommandOrder"),i=0;i<order.length;i++)slct.append(slct.find('option[value="'+order[i]+'"]').remove())}betaFeatures.CHANGESET_HELPER?($("#chkBetaCSHelper").prop("checked",!0),"V2"===betaFeatures.CHANGESET_HELPER?$("#slctChangeSetHelperVersion").val("V2"):$("#slctChangeSetHelperVersion").val("V1")):$("#chkBetaCSHelper").prop("checked",!1),switchGDriveBackup(!(!betaFeatures.GDRIVE_SYNC||!betaFeatures.GDRIVE_SYNC.BACKUP_ENABLED)),$("#slctApiLevel").val(apiLevel||$C.SF_API.LEVEL),$("#_inputTabSize").val(betaFeatures.FORMULA_EDITOR_OPTIONS.TAB_SIZE||2).on("change",function(){$("#_tabSizeLabel").html($(this).val())}).on("input",function(){$("#_tabSizeLabel").html($(this).val())}),$("#_tabSizeLabel").html($("#_inputTabSize").val()),$("#backupNumInp").val(maxBackupsNum),$("#saveBackupNumBtn").on("click",function(){var value=$("#backupNumInp").val();try{value=parseInt(value)}catch(ex){value=PopupUtils.MaxBackupNumDefault}value<0&&(value=0),value>100&&(value=100),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameMaxBackupsNum,value,function(){return reloadPage()})});for(var i=backups.length-1;i>=0;i--){var opt=$("<option />");opt.val(i).text(new Date(backups[i].createdDate).toISOString().replace("T"," ").split(".")[0]),$("#backupSlct").append(opt)}$("#downloadBackupBtn").on("click",function(){var downloadBackup=function(pwd){var i=parseInt($("#backupSlct").val()),backup=backups[i],body=LZString.decompressFromEncodedURIComponent(backup.body);if(backup.body=JSON.parse(body),backup.body.accounts&&backup.body.accounts.length)for(var ai=0;ai<backup.body.accounts.length;ai++)backup.body.accounts[ai].p&&(pwd?backup.body.accounts[ai].p=PopupUtils.decryptText(backup.body.accounts[ai].p,pwd):backup.body.accounts[ai].p=PopupUtils.deobfuscate(backup.body.accounts[ai].p));for(var oi=0;oi<backup.body.orgs.length;oi++)backup.body.orgs[oi].ql=JSON.parse(backup.body.orgs[oi].ql||"[]");var filename="backup-"+new Date(backup.createdDate).toISOString().replace(/\:/g,"-")+".json";PopupUtils.triggerDownloadTextFile(filename,"text/json",JSON.stringify(backup.body,null,2))};PopupUtils.getLocalPassphrase(function(err,pwd){if(err)return callback&&callback(err);var _storedPassPhrase=pwd||null;return _storedPassPhrase?handlePasswordRequest("Type current password: ",function(success,password){if(success)return password?_storedPassPhrase!==password?handleError("Invalid password, try again."):downloadBackup(password):handleError("Set a valid password.")}):downloadBackup()})}),$("#btnResetAPIUsage").click(function(){$G.setConfigParameterLocal(PopupUtils.StorageParamNameApiCounterDetails,{},function(err1){$G.setConfigParameterLocal(PopupUtils.StorageParamNameApiCounter,0,function(err2){$G.setConfigParameterLocal(PopupUtils.StorageParamNameApiCounterDate,(new Date).getTime(),function(){reloadPage()})})})}),$("#chkToggleDetails").click(function(){var enableDetails=$("#chkToggleDetails").is(":checked");PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameEnableAPIMonitorDetails,enableDetails,function(err,params){PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameApiCounterDetails,null),reloadPage()})}),$("#btnDownloadDetails").attr("disabled",!apiDetailsEnabled).click(function(){$G.getConfigParameterLocal(PopupUtils.StorageParamNameApiCounterDetails,function(err,params){var details=params[PopupUtils.StorageParamNameApiCounterDetails]||{},downloadBody=["oid,timestamp,count,endpoint"];for(var oid in details)if(details.hasOwnProperty(oid))for(var oidDetails=details[oid]||[],i=0;i<oidDetails.length;i++){var url=oidDetails[i].u||"";url.indexOf(",")>=0&&(url='"'+url+'"'),downloadBody.push(oid+","+new Date(oidDetails[i].t).toISOString()+","+oidDetails[i].v+","+url)}PopupUtils.triggerDownloadTextFile("API_details_"+(new Date).getTime()+".csv","text/csv",downloadBody.join("\n"))})}),$("#consumeLicenseBtn").attr("disabled",!0),$("#sendActivationAgainBtn").attr("disabled",!0),$("#licenseKey, #licensedEmail").on("keyup",function(){var disableBtn=!PopupUtils.checkPromoCodeDigits($("#licenseKey").val().trim())||!PopupUtils.checkEmailFormat($("#licensedEmail").val().trim());$("#consumeLicenseBtn").attr("disabled",disableBtn),$("#sendActivationAgainBtn").attr("disabled",disableBtn)}),$("#consumeLicenseBtn, #sendActivationAgainBtn").click(function(){var promoCode=$("#licenseKey").val().trim(),licensedEmail=$("#licensedEmail").val().trim(),activationKey=$("#activationKey").val().trim(),sendActivationAgain="1"===$(this).attr("data-resend-code"),deactivateClientId=$(this).attr("data-client-to-deactivate")||null;return $(this).attr("data-client-to-deactivate",null),promoCode&&PopupUtils.checkPromoCodeDigits(promoCode)?licensedEmail&&PopupUtils.checkEmailFormat(licensedEmail)?(handleLoadingMessage("Validating promo code...Please wait..."),$LicUtils.validatePromoCode(promoCode,licensedEmail,null,activationKey,sendActivationAgain,deactivateClientId,function(err,rslt){return err?(debug.log("validatePromoCode",err),handleLoadingMessage(""),err.requireClientActivation?($("#activationKey").parent().show(),$("#sendActivationAgainBtn").parent().show()):($("#activationKey").parent().hide(),$("#sendActivationAgainBtn").parent().hide()),err.requireClientActivation&&"ACTIVE_CLIENT_LIMIT_REACHED"===err.reason?handleClientsDeactivationPanel(err):err.showResponse?handleMessageDialog(err.message||err):handleError(""+err+" [3]")):new Date(rslt.expirationDate)<=new Date?(handleLoadingMessage(""),handleError("Promo code cannot be applied: it has expired on "+rslt.expirationDate)):PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,function(err,params){if(err)return handleLoadingMessage(""),callback&&callback(err+" [1]");for(var param=params[PopupUtils.StorageParamNamePromoCodes]||[],promoIndex=-1,li=0;li<param.length;li++)if(param[li].licenseKey===promoCode){promoIndex=li;break}return promoIndex<0&&param.push({licenseKey:promoCode,licensedEmail:licensedEmail,sku:rslt.productSku}),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,param,function(err){return err?callback&&callback(err+"[2]"):void PopupUtils.syncData({noQuotaCheck:!0},function(err){return err?(PopupUtils.logError(err),handleError(err)):void chrome.runtime.sendMessage({action:"BKG-REFRESH-PURCHASED-PRODUCTS",forceRefresh:!0},function(rslt){return handleLoadingMessage(""),handleMessageDialog("Promo code applied succesfully!",function(){return reloadPage()})})})})})})):handleError("Insert email address."):handleError("Insert a valid promo code.")}),$("#gdriveGetBackups").click(function(){return handleLoadingMessage("Loading GDrive backups...Please wait..."),PopupUtils.getLocalCode(function(extensionUniqueCode){return $LicUtils.getOAuthTokens(function(err,tokens){if(err)return handleLoadingMessage(),handleError(err);if(!tokens||!tokens.access_token)return handleLoadingMessage(),handleError(new Error("Google access token not found. Need user authorization."));var listOptions={tokens:tokens,dontUpdateLastAPIUsageDate:!0};return $BackupUtils.listGDriveBackups(listOptions,function(err,listResult){if($("#gdriveGetBackups").attr("disabled",!0),handleLoadingMessage(),err||!listResult.length)return $("#gdriveBackupListMsg").show(),void(err&&$("#gdriveBackupListMsg").text("Unexpected error: "+err+". Please retry."));$("#gdriveBackupTable").show(),$("#gdriveGetBackups").attr("disabled",!0).text("Retrieved "+listResult.length+" / "+$BackupUtils.MAX_REMOTE_BACKUPS+" backups");for(var tbody=$("#gdriveBackupTable tbody"),i=0;i<listResult.length;i++){var currentExtensionUniqueCode=listResult[i].properties.uc&&extensionUniqueCode===listResult[i].properties.uc,tr=$("<tr/>");currentExtensionUniqueCode&&tr.addClass("info");var tdCheck=$("<td/>"),tdMD5=$("<td/>").text(listResult[i].properties.md5),tdMExtId=$("<td/>").text(listResult[i].properties.extensionId),tdPasswordProtected=$("<td/>"),tdCreated=$("<td/>").text(new Date(parseInt(listResult[i].properties.d)).toLocaleString()),tdClientDetails=$("<td/>"),tdAction=$("<td/>");tr.append(tdCheck).append(tdCreated).append(tdPasswordProtected).append(tdMD5).append(tdMExtId).append(tdClientDetails).append(tdAction),tbody.append(tr),"true"===listResult[i].properties.protected&&tdPasswordProtected.append($('<center><span class="fa fa-lock" title="Password protected backup"/></center>'));var chkbox=$('<input type="checkbox"/>').attr("data-gdrive-file-id",listResult[i].id);tdCheck.append(chkbox),tdClientDetails.text(listResult[i].properties.userAgent);var downloadBackupBtn=$('<button class="btn btn-xs btn-default" title="Download"><span class="fa fa-download" /></button>').attr("data-gdrive-file-id",listResult[i].id).attr("data-gdrive-file-md5",listResult[i].properties.md5).attr("data-gdrive-file-timestamp",listResult[i].properties.d).attr("data-gdrive-extension-unique-code",listResult[i].properties.uc).attr("data-gdrive-extension-id",listResult[i].properties.extensionId).click(function(){var _self=this,getOptions={remotePackageInfo:{tokens:tokens,fileId:$(this).attr("data-gdrive-file-id")}};$BackupUtils.getGDriveBackup(getOptions,function(err,data){if(err)return console.error(err,data),handleError("Unexpected error: "+err);var backupData=$BackupUtils.parseSyncChunks(data);backupData=backupData||{},backupData.otherParameters=backupData.otherParameters||{};for(var downloadBody={accounts:backupData.accounts,orgs:backupData.orgs,scripts:backupData.otherParameters[PopupUtils.StorageParamNameVISs],queries:backupData.otherParameters[PopupUtils.StorageParamNameVIQs]},i=0;i<downloadBody.orgs.length;i++)downloadBody.orgs[i].ql&&(downloadBody.orgs[i].ql=JSON.parse(downloadBody.orgs[i].ql));return handlePasswordRequest("If the backup was password protected, input password below, otherwise leave blank:if wrong encryption password, no login password will be retrieved.",function(result,pwd){if(result){for(var i=0;i<downloadBody.accounts.length;i++)try{pwd?downloadBody.accounts[i].p=PopupUtils.decryptText(downloadBody.accounts[i].p,pwd):downloadBody.accounts[i].p=PopupUtils.deobfuscate(downloadBody.accounts[i].p,$(_self).attr("data-gdrive-extension-id"))}catch(ex){downloadBody.accounts[i].p=null,debug.error("Error decrypting password for item ["+i+"]: "+ex)}PopupUtils.triggerDownloadTextFile("backup_"+$(_self).attr("data-gdrive-file-timestamp")+".json","text/json",JSON.stringify(downloadBody,null,2))}})})});tdAction.append(downloadBackupBtn);var deleteBackupBtn=$('<button class="btn btn-xs btn-default" title="Delete backup"><span class="fa fa-trash" /></button>').attr("data-gdrive-file-id",listResult[i].id).click(function(){var _self=this,deleteOptions={dontUpdateLastAPIUsageDate:!0,remotePackageInfo:{tokens:tokens,fileId:$(this).attr("data-gdrive-file-id")}};return handleConfirm("Are you sure you want to delete this backup?",function(result){if(result)return $BackupUtils.deleteGDriveBackup(deleteOptions,function(err,data){return err?(console.error(err,data),handleError("Unexpected error: "+err)):void _self.closest("tr").remove()})})});tdAction.append(deleteBackupBtn)}})})})}),$("#gdriveSelectAll").click(function(){$("#gdriveBackupTable").find('input[type="checkbox"]').prop("checked",$(this).prop("checked"))}),$("#gdriveBackupMaxNum").text($BackupUtils.MAX_REMOTE_BACKUPS);var backupAppPanel=$("#backupAppPanel");PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccountGroupSorted,PopupUtils.StorageParamNameAccountsOnGroupSorted,PopupUtils.StorageParamNameApiLevel],function(err,params){var sortedGroups=params[PopupUtils.StorageParamNameAccountGroupSorted]||[],sortedLoginOnGroups=params[PopupUtils.StorageParamNameAccountsOnGroupSorted]||{},apiLevel=(params||{})[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL;PopupUtils.getLocalPassphrase(function(err,val){PopupUtils.decryptLocalAccounts(val||null,function(err,localLogins){localLogins=localLogins||[],localLogins.sort(function(a,b){return PopupUtils.sortLoginsHandler(a,b,sortedGroups,sortedLoginOnGroups)}),backupAppPanel.append(BackupConnector.init({logins:localLogins,apiLevel:apiLevel,errorHandler:handleError,keyRequestHandler:handleBackupKeyRequest,loadingHandler:handleLoadingMessage,selectedLoginsHandler:function(newLogins){newLogins&&newLogins.length&&PopupUtils.getLocalPassphrase(function(err,pwd){PopupUtils.decryptLocalAccounts(pwd||null,function(err,localLogins){localLogins=localLogins||[];for(var i=0;i<newLogins.length;i++){for(var nl=newLogins[i],found=!1,j=0;j<localLogins.length;j++){var ol=localLogins[j];if(nl.u===ol.u){localLogins.splice(j,1,nl),found=!0;break}}found||localLogins.push(nl)}for(var j=0;j<localLogins.length;j++)pwd?localLogins[j].p=PopupUtils.encryptText(localLogins[j].p,pwd):localLogins[j].p=PopupUtils.obfuscate(localLogins[j].p);PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameAccounts,localLogins,function(err){return err?(PopupUtils.logError(err),handleError(err)):PopupUtils.syncData({noQuotaCheck:!1},function(err){return err?(PopupUtils.logError(err),handleError(err)):handleMessageDialog("Logins succesfully downloaded.")})})})})}}))})})})})})};return handleLoadingMessage("Loading settings, please wait..."),PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameOldSyncMethod,PopupUtils.StorageParamNameWorkerSyncStatus],function(err,params){return params=params||{},params[PopupUtils.StorageParamNameWorkerSyncStatus]=params[PopupUtils.StorageParamNameWorkerSyncStatus]||{},params[PopupUtils.StorageParamNameOldSyncMethod]||params[PopupUtils.StorageParamNameWorkerSyncStatus].passwordRequest?(debug.log("syncFromSyncStorage..."),void PopupUtils.syncFromSyncStorage(disableInterface,handlePasswordRequest,function(err,returnObject){return err?handleError(err):PopupUtils.getLocalPassphrase(function(err,val){return err?(PopupUtils.logError(err),handleError(err)):(currentPassword=val,encriptionEnabled=!!currentPassword,void initUI())})})):PopupUtils.getLocalPassphrase(function(err,val){return err?(PopupUtils.logError(err),handleError(err)):(currentPassword=val,encriptionEnabled=!!currentPassword,void initUI())})})})}),global.true=exports}({},function(){return this}());