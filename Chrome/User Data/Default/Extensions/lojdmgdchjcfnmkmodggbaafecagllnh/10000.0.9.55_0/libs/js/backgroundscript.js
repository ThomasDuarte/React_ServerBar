/* ORGanizer for Salesforce - v10000.0.9.53 
 * Author: Enrico Murru (https://organizer.solutions/)
 * Copyright 2016-2024
 */
!function(exports,global){var _requireInitCompleted=null,getPurchasedProducts=null,refreshPurchasedProducts=null,sendSyncEvent=null;require(["jquery","global","constants","popup-utils","salesforce-client","zip","organizer-apis","licensing-utils","backup-utils"],function(jQuery,$G,$C,PopupUtils,$SalesforceClient,$zip,$ExtAPI,$LicUtils,$BackupUtils){var chrome=$G.chrome,window=$G.window,debug=PopupUtils.newDebugger("ORGanizer: BG-Script");chrome.tabs.onUpdated.addListener(function(tabid,changeInfo,tab){(changeInfo.url||"complete"===changeInfo.status)&&PopupUtils.getCookieStoreFromTabId(tab.id,function(storeId){chrome.cookies.getAll({name:"sid",url:tab.url,storeId:storeId+""},function(cookies){if(cookies&&cookies.length&&cookies[0].value){var oid=cookies[0].value.split("!")[0];PopupUtils.getActiveSessions(tab.id,storeId,function(err,sessions){sessions[oid]&&chrome.tabs.sendMessage(tab.id,{action:"CNT-SCRIPT-LOADED"},function(response){})})}})})});var _orgDescribes={},_purchasedProducts=null,_lastProductsCheck=null;debug.log("Initialized, isContent? "+PopupUtils.isRunningContent()),window.sendSyncEvent=function(callback){debug.log("Sending sync event (background)..."),window.refreshPurchasedProducts(!1,function(err,prodlist){$BackupUtils.handleBackgroundBackupAndSync2({purchasedProducts:window.getPurchasedProducts()},function(err){return PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameOldSyncMethod,function(err,params){if(params=params||{},params[PopupUtils.StorageParamNameOldSyncMethod])return callback&&callback();debug.log("setupFromSyncStorage on background...");var disableInterface=function(msg){},handlePasswordRequest=function(msg){return PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameWorkerSyncStatus,{passwordRequest:!0,errorMessage:null,lastCheck:(new Date).getTime()})};return PopupUtils.syncFromSyncStorage(disableInterface,handlePasswordRequest,function(err,returnObject){return err?PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameWorkerSyncStatus,{passwordRequest:!1,errorMessage:err+"",lastCheck:(new Date).getTime()},callback):PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameWorkerSyncStatus,{passwordRequest:!1,errorMessage:null,lastCheck:(new Date).getTime()},callback)})})})})},chrome.runtime.onMessage.addListener(function(request,sender,sendResponse){if(!sender.tab&&request.tab&&(sender.tab=request.tab),"BKG-DO-AJAX-CALL"===request.action){var options=request.options;return options.success=function(data,textStatus,request){return debug.log("BKG-DO-AJAX-CALL (success)",data,textStatus,request),sendResponse&&sendResponse({success:{data:data,textStatus:textStatus,request:request}})},options.error=function(request,textStatus,errorThrown){return debug.log("BKG-DO-AJAX-CALL (error)",request,textStatus,errorThrown),sendResponse&&sendResponse({error:{request:request,textStatus:textStatus,errorThrown:errorThrown}})},PopupUtils.ajaxCall(request.options),!0}if("BKG-DEFROST-UI"===request.action)return $LicUtils.resetActionsCounter(sendResponse),!0;if("BKG-SEND-ANALYTICS-EVENT"===request.action)return debug.log("Send Analytics event:",request.eventCategory,request.eventAction),PopupUtils.trackAnalyticsEvent(request.eventAction,request.eventCategory),$LicUtils.handleActionsCounterIncrement({eventCategory:request.eventCategory,eventAction:request.eventAction},function(err){return err&&debug.error(err),sendResponse&&sendResponse()}),!0;if("BKG-IS-LEX-TOP-FRAME"===request.action)return chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(tabs){if(!tabs||!tabs.length)return sendResponse&&sendResponse(!1);var url=tabs[0].url,isLex=PopupUtils.isLEX(url);chrome.tabs.sendMessage(tabs[0].id,{action:"GET-ORG-PARAMS-FOR-IFRAME"},function(orgParams){return sendResponse&&sendResponse({isLex:isLex,orgParams:orgParams})})}),!0;if("BKG-KEYDOWN"===request.action)return chrome.tabs.sendMessage(sender.tab.id,{action:"CNT-KEYDOWN",evt:request.evt}),sendResponse&&sendResponse();if("BKG-DOWNLOAD-FILE"===request.action)return"zip"===request.mode?PopupUtils.triggerDownloadZipFile(request.filename,request.body):PopupUtils.triggerDownloadTextFile(request.filename,request.contentType,request.body),sendResponse&&sendResponse();if("BKG-READ-PACKAGE-ZIP-DATA"===request.action)return $zip.workerScriptsPath=chrome.runtime.getURL("/libs/zip/"),$zip.createReader(new $zip.Data64URIReader(request.data),function(reader){reader.getEntries(function(entries){var readFunctionsArray=[],unzippedFiles={},readFile=function(entry){return function(){entry.getData(new $zip.TextWriter,function(text){return unzippedFiles[entry.filename]=text,readFunctionsArray.splice(0,1),readFunctionsArray.length?readFunctionsArray[0]():(reader.close(),sendResponse&&sendResponse({success:!0,results:unzippedFiles}))})}};if(!entries.length)return reader.close(),sendResponse&&sendResponse({success:!1,error:new Error("No file in zip")});for(var i=0;i<entries.length;i++)readFunctionsArray.push(readFile(entries[i]));readFunctionsArray[0]()})},function(error){return sendResponse&&sendResponse({success:!1,error:error})}),!0;if("BKG-OPEN-INCOGNITO-LINK"===request.action)return chrome.extension.isAllowedIncognitoAccess(function(isAllowedAccess){isAllowedAccess&&chrome.windows.create({url:request.url,type:"normal",incognito:!0})}),sendResponse&&sendResponse();if("BKG-GET-ORG-PARAMS"===request.action)return window.refreshPurchasedProducts(!1,function(err,products){debug.log('BKG . request.action === "BKG-GET-ORG-PARAMS" >>> ',err,products);$LicUtils.checkActionsCounterHit(function(err,hit){PopupUtils.getORGParams(sender.tab.id,sender.tab.url,request.isLex,request.fromAPI,_orgDescribes,_purchasedProducts,hit,function(orgParamsPayload){return PopupUtils.cacheDescribeValues(_orgDescribes),sendResponse&&sendResponse(orgParamsPayload)})})}),!0;if("BKG-RESET-DESCRIBE"===request.action)return _orgDescribes={},PopupUtils.resetCacheDescribeValues(sendResponse),!0;if("BKG-GET-PURCHASED-PRODUCTS"===request.action){var purcProds=window.getPurchasedProducts();return debug.log("BKG-GET-PURCHASED-PRODUCTS: purcProds",purcProds),purcProds?sendResponse&&sendResponse({error:null,purchasedProducts:purcProds}):(window.refreshPurchasedProducts(!1,sendResponse),!0)}if("BKG-REFRESH-PURCHASED-PRODUCTS"===request.action)return window.refreshPurchasedProducts(request.forceRefresh,sendResponse),!0;if("BKG-SYNC"===request.action)return window.sendSyncEvent(function(){return sendResponse&&sendResponse()}),!0;if("BKG-LOGIN-ACTION"===request.action){var url=request.url,inputs=request.inputs,incognitoMode=request.incognitoMode,newWindow=request.newWindow,formFunc=function(url,inputs){document.getElementById("login_form").remove();var loginMessage=document.createTextNode("ORGanizer is getting you in...wait a second..."),mainFormDiv=document.getElementById("theloginform");mainFormDiv.insertBefore(loginMessage,mainFormDiv.firstChild);var form=document.createElement("form");form.setAttribute("style","display:hidden;"),form.setAttribute("action",url),form.setAttribute("method","post"),form.innerHTML=inputs;var bd=window.document.getElementsByTagName("body")[0];bd.appendChild(form),form.submit()};return newWindow?chrome.windows.create({url:url,type:"normal",incognito:incognitoMode},function(wnd){chrome.scripting.executeScript({target:{tabId:wnd.tabs[0].id},func:formFunc,args:[url,inputs]}).then(function(){return sendResponse&&sendResponse()})}):chrome.tabs.create({url:url},function(tab){chrome.scripting.executeScript({target:{tabId:tab.id},func:formFunc,args:[url,inputs]}).then(function(){return sendResponse&&sendResponse()})}),!0}}),window.refreshPurchasedProducts=window.refreshPurchasedProducts||function(force,callback){return PopupUtils.loadAjaxCache(function(cache){debug.log("cache",cache),cache&&cache.purchasedProducts&&cache.lastProductsCheck&&(debug.log("Cache",cache),_lastProductsCheck=cache.lastProductsCheck,_purchasedProducts=cache.purchasedProducts||[]);var cacheTime=(new Date).getTime()-(_lastProductsCheck||0);return debug.log("Cache time: ",force,cacheTime),!force&&_lastProductsCheck&&cacheTime<($C.PurchasedProducts_Refresh||864e5)?(debug.log("getPurchasedStoreProducts cached ["+$C.PurchasedProducts_Refresh+" ms]"),debug.log("_purchasedProducts",_purchasedProducts),callback&&callback({error:null,purchasedProducts:_purchasedProducts})):(_purchasedProducts||(_purchasedProducts=[]),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,function(err,params){function validateOne(promo){return function(){$LicUtils.validatePromoCode(promo.licenseKey,promo.licensedEmail,promo.sku,null,null,null,function(err,promoDetails){var promoProduct;if(debug.log("validateOne:",promo,err,promoDetails),err){if(debug.log("#### _purchasedProducts",_purchasedProducts),!err.validationError&&!err.unauthenticated)for(var x=0;x<_purchasedProducts.length;x++)if(_purchasedProducts[x].itemId===promo.licenseKey){promoProduct=_purchasedProducts[x];break}err.requireClientActivation&&(promoProduct={kind:"promo",itemId:promo.licenseKey,sku:"-",state:"Please reapply this license ("+err.message+")",expiration:"",userEmail:promo.licensedEmail}),err.unauthenticated?promoProduct={kind:"promo",itemId:promo.licenseKey,sku:"-",state:"AUTHENTICATION NEEDED",expiration:"",userEmail:promo.licensedEmail}:err.validationError||!promoProduct?promoProduct={kind:"promo",itemId:promo.licenseKey,sku:"-",state:"VALIDATION ERROR - TRY TO REAPPLY",expiration:"",userEmail:promo.licensedEmail}:err.notFound&&(promoProduct={kind:"promo",itemId:promo.licenseKey,sku:"-",state:"EXPIRED / NOT FOUND / INVALID USER",expiration:"-",manageUrl:"",userEmail:promo.licensedEmail}),debug.error("Cannot retrieve promo details:",err)}else{var isExpired=new Date(promoDetails.expirationDate)<new Date;promoProduct={kind:"promo",itemId:promoDetails.code,sku:promoDetails.productSku,state:isExpired?"EXPIRED":"ACTIVE",expiration:promoDetails.expirationDate,manageUrl:promoDetails.manageUrl,userEmail:promoDetails.userEmail}}return promoProducts.push(promoProduct),validationsFunList.length?validationsFunList.splice(0,1)[0]():validatePromoCallback(promoProducts)})}}var promos=params[PopupUtils.StorageParamNamePromoCodes]||[];debug.log("Promo Codes: ",promos);var validatePromoCallback=function(promoProducts){_purchasedProducts=promos.length?_purchasedProducts||[]:[];for(var pci=_purchasedProducts.length-1;pci>=0;pci--)if("promo"===_purchasedProducts[pci].kind){for(var promoIndex=-1,li=0;li<promos.length;li++)if(promos[li].licenseKey===_purchasedProducts[pci].itemId){promoIndex=li;break}(promoIndex<0||!_purchasedProducts[pci].itemId)&&_purchasedProducts.splice(pci,1)}debug.log("getPurchasedStoreProducts [end]",err,_purchasedProducts,promoProducts),promoProducts&&(_purchasedProducts=_purchasedProducts.concat(promoProducts)),_purchasedProducts=(_purchasedProducts||[]).filter(function(item,pos){for(var tmpi=_purchasedProducts.length-1;tmpi>pos;tmpi--)if(tmpi!==pos&&item.itemId===_purchasedProducts[tmpi].itemId)return!1;return!0}),cache.lastProductsCheck=(new Date).getTime(),cache.purchasedProducts=_purchasedProducts,PopupUtils.storeAjaxCache(cache,function(){return callback&&callback({error:err,purchasedProducts:_purchasedProducts})})};if(!promos.length)return validatePromoCallback();for(var promoProducts=[],validationsFunList=[],i=0;i<promos.length;i++)validationsFunList.push(validateOne(promos[i]));validationsFunList.splice(0,1)[0]()}))})},window.getPurchasedProducts=window.getPurchasedProducts||function(){return _purchasedProducts},_requireInitCompleted=function(details){details&&("install"!==details.reason&&"update"!==details.reason||(PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameLastVersionInstalled,!0),PopupUtils.getLocalCode(),PopupUtils.backupData(function(err2){err2&&(PopupUtils.logError(err2),console.error("Error initializing new version: ",err2))})))},PopupUtils.initLoadCacheDescribeValues(function(describeValues){_orgDescribes=describeValues}),window.sendSyncEvent(function(){window.refreshPurchasedProducts(!1,function(err,rslt){})}),chrome.alarms.create("BackgroundSync",{periodInMinutes:$C.BackgroundBackupSyncPeriod}),chrome.alarms.create("BackgroundRefreshProducts",{periodInMinutes:$C.BackgroundLicenseCheckSyncPeriod}),chrome.alarms.onAlarm.addListener(function(alarm){"BackgroundSync"===alarm.name&&(window.sendSyncEvent(),debug.log("Background backup in progress..."),PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBetaFeatures,PopupUtils.StorageParamNameLogAlarms],function(err,params){if((params[PopupUtils.StorageParamNameBetaFeatures]||{}).DEBUGGING){var logAlarms=params[PopupUtils.StorageParamNameLogAlarms]||{};logAlarms.BackgroundSync=logAlarms.BackgroundSync||[],logAlarms.BackgroundSync.length>100&&(logAlarms.BackgroundSync=logAlarms.BackgroundSync.slice(logAlarms.BackgroundSync.length-100)),logAlarms.BackgroundSync.push((new Date).getTime()),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameLogAlarms,logAlarms)}}))}),chrome.alarms.onAlarm.addListener(function(alarm){"BackgroundRefreshProducts"===alarm.name&&(window.refreshPurchasedProducts(),debug.log("Background license check in progress..."),PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBetaFeatures,PopupUtils.StorageParamNameLogAlarms],function(err,params){if((params[PopupUtils.StorageParamNameBetaFeatures]||{}).DEBUGGING){var logAlarms=params[PopupUtils.StorageParamNameLogAlarms]||{};logAlarms.BackgroundRefreshProducts=logAlarms.BackgroundRefreshProducts||[],logAlarms.BackgroundRefreshProducts.length>100&&(logAlarms.BackgroundRefreshProducts=logAlarms.BackgroundRefreshProducts.slice(logAlarms.BackgroundRefreshProducts.length-100)),logAlarms.BackgroundRefreshProducts.push((new Date).getTime()),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameLogAlarms,logAlarms)}}))})}),chrome.runtime.onInstalled.addListener(function(details){var checkInitCompleted=function(){return _requireInitCompleted?_requireInitCompleted(details):setTimeout(checkInitCompleted,500)};return checkInitCompleted()}),exports._requireInitCompleted=_requireInitCompleted,exports.getPurchasedProducts=getPurchasedProducts,exports.refreshPurchasedProducts=refreshPurchasedProducts,exports.sendSyncEvent=sendSyncEvent,global.true=exports}({},function(){return this}());