/* ORGanizer for Salesforce - v10000.0.9.53 
 * Author: Enrico Murru (https://organizer.solutions/)
 * Copyright 2016-2024
 */
!function(exports,global){define("field-history",["global","constants","jquery","popup-utils","salesforce-client"],function($G,$C,$,PopupUtils,$SalesforceClient){"use sctrict";var $client,counterPanel,FIELD_HISTORY_PAGE="setup/layout/FieldHistoryTracking",QUERY_LIMIT=1e3,window=($G.chrome,$G.window),_init=!1,_isLex=!1,_domainAPI=null,_sid=null,_apiLevel="41.0",fieldsDetails={},debug=PopupUtils.newDebugger("ORGanizer: field-history-utils"),onCheckboxClick=function(){var count=$('input[id$="_fht"][type=checkbox]:checked').length;debug.log("COUNT: ",count),counterPanel.find(".counter").text(count)},analizeRecords=function(records){debug.log("Records: ",records);for(var key in fieldsDetails)if(fieldsDetails.hasOwnProperty(key)){var fld=fieldsDetails[key];void 0===fld.nullValues&&(fld.nullValues=0,fld.filledValues=0,fld.maxVariance=0);for(var values={},i=0;i<records.length;i++){var record=records[i],value=record[fld.QualifiedApiName];void 0!==value&&(values[""+value]=(values[""+value]||0)+1,null===value?fld.nullValues++:fld.filledValues++)}for(var v in values)fld.maxVariance<values[v]&&(fld.maxVariance=values[v])}debug.log(fieldsDetails)},initDescribe=function(entityId,callback){var fieldsIds=[],fieldAPINames=[];$('input[id$="_fht"][type=checkbox]').each(function(){var name=$(this).attr("name");fieldsIds.push(name)}),$client.getObjectToolingDetails(entityId,function(err,objInfo){return debug.log(err,objInfo,entityId),err?(debug.error(err),callback(err)):void $client.getAllFieldsId(null,objInfo[0].QualifiedApiName,function(err,objDescr){if(debug.log(err,objDescr),err)return debug.error(err),callback(err);for(var i=0;i<objDescr.records.length;i++){var fld=objDescr.records[i],fid=fld.DurableId.split(".")[1];fieldsDetails[fid]=fld}$('input[id$="_fht"][type=checkbox]').each(function(){var name=$(this).attr("name");fieldAPINames.push(fieldsDetails[name].QualifiedApiName)});for(var queries=[],joinedFields="",f=0;f<fieldAPINames.length;f++)fieldAPINames[f].indexOf("__pc")>0||(joinedFields+=fieldAPINames[f]+",",(joinedFields.length>9900||f>=fieldAPINames.length-1)&&(joinedFields=joinedFields.substr(0,joinedFields.length-1),queries.push(joinedFields),joinedFields=""));debug.log("Queries",queries);for(var queryFuns=[],recordCount=0,queryCallback=function(err){return $('input[id$="_fht"][type=checkbox]').each(function(){var name=$(this).attr("name"),fld=fieldsDetails[name],lblTD=$(this).parent().prev(),apiNameSpan=$("<span/>").addClass("ui-organizer-link");apiNameSpan.text(" ("+fld.QualifiedApiName+") "),lblTD.append(apiNameSpan);var percent1=Math.round((fld.filledValues||0)/(recordCount||1)*100),percent2=100-Math.round((fld.maxVariance||0)/(recordCount||1)*100),percentColor1=percent1<50?"red":percent1<70?"orange":"green",percentColor2=percent2<50?"red":percent2<70?"orange":"green",percElement=$('<span>Filled: <strong style="cursor:help;font-family:monospace; font-size:10pt; color:'+percentColor1+'">'+percent1+'</strong> % Variance: <strong style="cursor:help;font-family:monospace; font-size:10pt; color:'+percentColor2+'">'+percent2+"</strong> %</span>");percElement.attr("title","Number of record filled: "+fld.filledValues+" / "+recordCount+"\nMaximum fields with same value: "+fld.maxVariance+" / "+recordCount),$(this).parent().append(percElement)}),callback(err)},queryFunction=function(queryString){return function(){debug.log("Querying all fields: ",queryString),$client.query(!1,queryString,function(err,records){if(err)return queryCallback(err);if(recordCount=records.length,analizeRecords(records),queryFuns.length>0){var fn=queryFuns.splice(0,1)[0];return fn()}return queryCallback()})}},fi=0;fi<queries.length;fi++){var queryStr="SELECT "+queries[fi]+" FROM "+objInfo[0].QualifiedApiName+" ORDER BY CreatedDate DESC LIMIT "+QUERY_LIMIT;queryFuns.push(queryFunction(queryStr))}debug.log("queryFuns.length = ",queryFuns.length);var fn=queryFuns.splice(0,1)[0];return fn()})})};return{render:function(isLex,domainAPI,sid,apiLevel){if(_isLex=isLex,_domainAPI=domainAPI,_sid=sid,_apiLevel=apiLevel||_apiLevel,$client=new $SalesforceClient.Client("https://"+_domainAPI,_sid,_apiLevel),!_init){_init=!0;var url=window.location.href,entityId=$('input[type="hidden"][name="pEntity"]').val();if(!(url.indexOf(FIELD_HISTORY_PAGE)<0)){$('input[id$="_fht"][type=checkbox]').click(onCheckboxClick),$("#fldEdit .pbBody .pbSubsection a").click(function(){setTimeout(onCheckboxClick,100)});var panelContainer=$("#fldEdit .pbBody .pbSubsection a").parent().parent().parent().parent().parent();counterPanel=$('<div class="bPageBlock ui-organizer-pageblock"><div class="pbBody"><div class="pbSubsection"><table class="detailList ui-plugin-body" border="0" cellpadding="0" cellspacing="0"><tbody><tr><th class="labelCol vfLabelColTextWrap first" scope="row"><div>Selected Fields:</div></th><td class="dataCol first"><strong class="ui-organizer-pageblock-title counter" style="font-size:12pt;">...</strong></td><th class="labelCol vfLabelColTextWrap first" scope="row"><div></div></th><td class="dataCol first"><div><input type="button" id="btnDiscover" class="ui-organizer-input ui-pointer" value="Analyze fields..." /></div></td></tr></tbody></table><div class="ui-textarea-footer text-muted" style="font-size:9pt; font-family:monospace; text-align:right;"><a class="ui-organizer-link" style="color: gray;" target="_blank" href="'+$C.Endpoints.FAQPage+'#history">ORGanizer for Salesforce Field History Plugin</a></div></div></div></div>'),panelContainer.append(counterPanel),$("#btnDiscover").attr("title","Retrieve field API names and stats on fields on the last "+QUERY_LIMIT+" records created. This can take a while. \nIf object has hundreds of fields, this can take more than a while.").click(function(){$("#btnDiscover").attr("value","Loading...").attr("disabled",!0).attr("class","btnDisabled"),initDescribe(entityId,function(err){return console.log("ERRORE",err),err?err.length&&"INVALID_FIELD"===err[0].errorCode?alert("[ORGanizer] Describe failed due to no access to object fields. Check your profile's Field Level Security configuration."):alert(JSON.stringify(err)):void $("#btnDiscover").attr("value","Refresh page to retry").attr("disabled",!0).attr("class","btnDisabled")})}),onCheckboxClick()}}}}}),global.true=exports}({},function(){return this}());